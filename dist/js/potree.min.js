"use strict";function BinaryHeap(t){this.content=[],this.scoreFunction=t}function LRUItem(t){this.next=this.previous=null,this.node=t}function LRU(){this.last=this.first=null,this.items={},this.numPoints=this.elements=0}BinaryHeap.prototype={push:function(t){this.content.push(t),this.bubbleUp(this.content.length-1)},pop:function(){var t=this.content[0],e=this.content.pop();return 0<this.content.length&&(this.content[0]=e,this.sinkDown(0)),t},remove:function(t){for(var e=this.content.length,n=0;n<e;n++)if(this.content[n]==t){if(t=this.content.pop(),n==e-1)break;this.content[n]=t,this.bubbleUp(n),this.sinkDown(n);break}},size:function(){return this.content.length},bubbleUp:function(t){for(var e=this.content[t],n=this.scoreFunction(e);0<t;){var i=Math.floor((t+1)/2)-1,r=this.content[i];if(n>=this.scoreFunction(r))break;this.content[i]=e,this.content[t]=r,t=i}},sinkDown:function(t){for(var e=this.content.length,n=this.content[t],i=this.scoreFunction(n);;){var r=2*(t+1),o=r-1,s=null;if(o<e){var a=this.scoreFunction(this.content[o]);a<i&&(s=o)}if(r<e&&this.scoreFunction(this.content[r])<(null==s?i:a)&&(s=r),null==s)break;this.content[t]=this.content[s],this.content[s]=n,t=s}}},LRU.prototype.size=function(){return this.elements},LRU.prototype.contains=function(t){return null==this.items[t.id]},LRU.prototype.touch=function(t){if(t.loaded)if(null==this.items[t.id]){var e=new LRUItem(t);e.previous=this.last,this.last=e,null!==e.previous&&(e.previous.next=e),this.items[t.id]=e,this.elements++,null===this.first&&(this.first=e),this.numPoints+=t.numPoints}else null===(e=this.items[t.id]).previous?null!==e.next&&(this.first=e.next,this.first.previous=null,e.previous=this.last,e.next=null,this.last=e,e.previous.next=e):null!==e.next&&(e.previous.next=e.next,e.next.previous=e.previous,e.previous=this.last,e.next=null,this.last=e,e.previous.next=e)},LRU.prototype.remove=function(t){var e=this.items[t.id];e&&(1===this.elements?this.last=this.first=null:(e.previous||(this.first=e.next,this.first.previous=null),e.next||(this.last=e.previous,this.last.next=null),e.previous&&e.next&&(e.previous.next=e.next,e.next.previous=e.previous)),delete this.items[t.id],this.elements--,this.numPoints-=t.numPoints)},LRU.prototype.getLRUItem=function(){return null===this.first?null:this.first.node},LRU.prototype.freeMemory=function(){if(!(1>=this.elements))for(;this.numPoints>Potree.pointLoadLimit;)this.disposeDescendants(this.first.node)},LRU.prototype.disposeDescendants=function(t){for(t=[t];0<t.length;){var e=t.pop();for(var n in e.dispose(),this.remove(e),e.children)e.children.hasOwnProperty(n)&&e.children[n].loaded&&t.push(e.children[n])}},LRU.prototype.toString=function(){for(var t="{ ",e=this.first;null!==e;)t+=e.node.id,null!==e.next&&(t+=", "),e=e.next;return t+"}("+this.size()+")"};class EnumItem{constructor(t){for(var e of Object.keys(t))this[e]=t[e]}inspect(){return`Enum(${this.name}: ${this.value})`}}class Enum{constructor(t){for(var e of(this.object=t,Object.keys(t))){var n=t[e];"object"==typeof n?n.name=e:n={name:e,value:n},this[e]=new EnumItem(n)}}fromValue(t){for(var e of Object.keys(this.object))if(this[e].value===t)return this[e];throw Error(`No enum for value: ${t}`)}}class HelperUtils{static generateDataTexture(t,e,n){var i=t*e,r=new Uint8Array(4*t*e),o=Math.floor(255*n.r),s=Math.floor(255*n.g);n=Math.floor(255*n.b);for(var a=0;a<i;a++)r[3*a]=o,r[3*a+1]=s,r[3*a+2]=n;return(t=new THREE.DataTexture(r,t,e,THREE.RGBAFormat)).needsUpdate=!0,t.magFilter=THREE.NearestFilter,t}static computeTransformedBoundingBox(t,e){return t=[new THREE.Vector3(t.min.x,t.min.y,t.min.z).applyMatrix4(e),new THREE.Vector3(t.min.x,t.min.y,t.min.z).applyMatrix4(e),new THREE.Vector3(t.max.x,t.min.y,t.min.z).applyMatrix4(e),new THREE.Vector3(t.min.x,t.max.y,t.min.z).applyMatrix4(e),new THREE.Vector3(t.min.x,t.min.y,t.max.z).applyMatrix4(e),new THREE.Vector3(t.min.x,t.max.y,t.max.z).applyMatrix4(e),new THREE.Vector3(t.max.x,t.max.y,t.min.z).applyMatrix4(e),new THREE.Vector3(t.max.x,t.min.y,t.max.z).applyMatrix4(e),new THREE.Vector3(t.max.x,t.max.y,t.max.z).applyMatrix4(e)],(e=new THREE.Box3).setFromPoints(t),e}}function VersionUtils(t){this.version=t;var e=-1===t.indexOf(".")?t.length:t.indexOf(".");this.versionMajor=parseInt(t.substr(0,e)),this.versionMinor=parseInt(t.substr(e+1)),0===this.versionMinor.length&&(this.versionMinor=0)}VersionUtils.prototype.newerThan=function(t){return t=new VersionUtils(t),this.versionMajor>t.versionMajor||this.versionMajor===t.versionMajor&&this.versionMinor>t.versionMinor},VersionUtils.prototype.equalOrHigher=function(t){return t=new VersionUtils(t),this.versionMajor>t.versionMajor||this.versionMajor===t.versionMajor&&this.versionMinor>=t.versionMinor},VersionUtils.prototype.upTo=function(t){return!this.newerThan(t)};class WorkerManager{constructor(){this.workers=[];for(var t=0;5>t;t++)this.workers.push([])}getWorker(t){return 0<this.workers[t].length?this.workers[t].pop():new Worker(Potree.workerPath+WorkerManager.URLS[t])}returnWorker(t,e){this.workers[t].push(e)}runTask(t,e,n,i){var r=this,o=this.getWorker(t);o.onmessage=function(n){e(n),r.returnWorker(t,o)},void 0!==i?o.postMessage(n,i):o.postMessage(n)}}function Potree(){}WorkerManager.BINARY_DECODER=0,WorkerManager.LAS_LAZ=1,WorkerManager.LAS_DECODER=2,WorkerManager.GREYHOUND=3,WorkerManager.DEM=4,WorkerManager.URLS=["/workers/BinaryDecoderWorker.min.js","/workers/LASLAZWorker.min.js","/workers/LASDecoderWorker.min.js","/workers/GreyhoundBinaryDecoderWorker.min.js","/workers/DEMWorker.min.js"],Potree.getBasePath=function(){if(document.currentScript.src){var t=new URL(document.currentScript.src+"/..").href;return"/"===t.slice(-1)&&(t=t.slice(0,-1)),t}return console.error("Potree: Was unable to find its script path using document.currentScript."),""},Potree.workerPath=Potree.getBasePath(),Potree.maxNodesLoadGPUFrame=20,Potree.maxDEMLevel=0,Potree.maxNodesLoading=void 0!==navigator.hardwareConcurrency?navigator.hardwareConcurrency:4,Potree.pointLoadLimit=1e10,Potree.framenumber=0,Potree.numNodesLoading=0,Potree.debug={},Potree.measureTimings=!1,Potree.workerPool=new WorkerManager,Potree.lru=new LRU,Potree.attributeLocations={position:0,color:1,intensity:2,classification:3,returnNumber:4,numberOfReturns:5,pointSourceID:6,indices:7,normal:8,spacing:9},Potree.Classification={DEFAULT:{0:new THREE.Vector4(.5,.5,.5,1),1:new THREE.Vector4(.5,.5,.5,1),2:new THREE.Vector4(.63,.32,.18,1),3:new THREE.Vector4(0,1,0,1),4:new THREE.Vector4(0,.8,0,1),5:new THREE.Vector4(0,.6,0,1),6:new THREE.Vector4(1,.66,0,1),7:new THREE.Vector4(1,0,1,1),8:new THREE.Vector4(1,0,0,1),9:new THREE.Vector4(0,0,1,1),12:new THREE.Vector4(1,1,0,1),DEFAULT:new THREE.Vector4(.3,.6,.6,.5)}},Potree.ClipTask={NONE:0,HIGHLIGHT:1,SHOW_INSIDE:2,SHOW_OUTSIDE:3},Potree.ClipMethod={INSIDE_ANY:0,INSIDE_ALL:1},Potree.PointSizeType={FIXED:0,ATTENUATED:1,ADAPTIVE:2},Potree.PointShape={SQUARE:0,CIRCLE:1,PARABOLOID:2},Potree.PointColorType={RGB:0,COLOR:1,DEPTH:2,HEIGHT:3,ELEVATION:3,INTENSITY:4,INTENSITY_GRADIENT:5,LOD:6,LEVEL_OF_DETAIL:6,POINT_INDEX:7,CLASSIFICATION:8,RETURN_NUMBER:9,SOURCE:10,NORMAL:11,PHONG:12,RGB_HEIGHT:13,COMPOSITE:50},Potree.TreeType={OCTREE:0,KDTREE:1},Potree.loadPointCloud=function(t,e,n){var i=function(t){void 0!==e&&(t.name=e),n({type:"pointcloud_loaded",pointcloud:t})};if(0===t.indexOf("greyhound://"))Potree.GreyhoundLoader.load(t,function(t){t&&i(new PointCloudOctree(t))});else if(0<t.indexOf("cloud.js"))Potree.POCLoader.load(t,function(t){t&&i(new PointCloudOctree(t))});else{if(!(0<t.indexOf(".vpc")))throw Error("Potree: Failed to load point cloud from URL "+t);PointCloudArena4DGeometry.load(t,function(t){t&&i(new PointCloudArena4D(t))})}},Potree.updateVisibility=function(t,e,n){var i=0,r=new Map(t.map(t=>[t,0])),o=[],s=[],a=[],u=1/0,l=Potree.updateVisibilityStructures(t,e,n),d=l.frustums,h=l.camObjPositions;l=l.priorityQueue;var p=0;n=n.domElement.clientHeight,Potree._pointcloudTransformVersion||(Potree._pointcloudTransformVersion=new Map);for(var c=Potree._pointcloudTransformVersion,f=0;f<t.length;f++){var m=t[f];if(m.visible)if(m.updateMatrixWorld(),c.has(m)){var g=c.get(m);g.transform.equals(m.matrixWorld)||(g.number++,g.transform.copy(m.matrixWorld),m.dispatchEvent({type:"transformation_changed",target:m}))}else c.set(m,{number:0,transform:m.matrixWorld.clone()})}for(;0<l.size();){var y=(g=l.pop()).node;f=g.parent,m=t[g.pointcloud];var E=y.getBoundingBox(),v=h[g.pointcloud],T=d[g.pointcloud].intersectsBox(E);E=m.maxLevel||1/0;var x=y.getLevel();if(T=(T=T&&!(r.get(m)+y.getNumPoints()>m.pointBudget))&&x<E,y.spacing?u=Math.min(u,y.spacing):y.geometryNode&&y.geometryNode.spacing&&(u=Math.min(u,y.geometryNode.spacing)),T)for(0,i+=y.getNumPoints(),E=r.get(m),r.set(m,E+y.getNumPoints()),m.numVisibleNodes++,m.numVisiblePoints+=y.getNumPoints(),!y.isGeometryNode()||f&&!f.isTreeNode()||(y.isLoaded()&&p<Potree.maxNodesLoadGPUFrame?(y=m.toTreeNode(y,f),p++):(a.push(y),s.push(y))),y.isTreeNode()&&(Potree.lru.touch(y.geometryNode),y.sceneNode.visible=!0,y.sceneNode.material=m.material,o.push(y),m.visibleNodes.push(y),void 0===y._transformVersion&&(y._transformVersion=-1),f=c.get(m),y._transformVersion!==f.number&&(y.sceneNode.updateMatrix(),y.sceneNode.matrixWorld.multiplyMatrices(m.matrixWorld,y.sceneNode.matrix),y._transformVersion=f.number),m.showBoundingBox&&!y.boundingBoxNode&&y.getBoundingBox?((f=new THREE.Box3Helper(y.getBoundingBox())).matrixAutoUpdate=!1,m.boundingBoxNodes.push(f),y.boundingBoxNode=f,y.boundingBoxNode.matrix.copy(m.matrixWorld)):m.showBoundingBox?(y.boundingBoxNode.visible=!0,y.boundingBoxNode.matrix.copy(m.matrixWorld)):!m.showBoundingBox&&y.boundingBoxNode&&(y.boundingBoxNode.visible=!1)),E=y.getChildren(),f=0;f<E.length;f++){x=E[f];var P=0;if(e.isPerspectiveCamera){var b=x.getBoundingSphere(new THREE.Sphere);if(T=b.center.distanceTo(v),b=b.radius,(P=.5*n/(Math.tan(e.fov*Math.PI/180/2)*T)*b)<m.minimumNodePixelSize)continue;0>T-b&&(P=Number.MAX_VALUE)}else b=x.getBoundingBox(),T=x.getBoundingSphere(new THREE.Sphere).center.distanceTo(v),P=b.max.clone().sub(b.min).length()/T;l.push({pointcloud:g.pointcloud,node:x,parent:y,weight:P})}}for(m of t=t.filter(t=>t.generateDEM&&t.dem instanceof PotreeDEM))t=m.visibleNodes.filter(t=>t.getLevel()<=Potree.maxDEMLevel),m.dem.update(t);for(f=0;f<Math.min(Potree.maxNodesLoading,a.length);f++)a[f].load();return{visibleNodes:o,numVisiblePoints:i,lowestSpacing:u}},Potree.updatePointClouds=function(t,e,n){for(var i=Potree.updateVisibility(t,e,n),r=0;r<t.length;r++)t[r].updateMaterial(t[r].material,t[r].visibleNodes,e,n),t[r].updateVisibleBounds();return Potree.lru.freeMemory(),i},Potree.updateVisibilityStructures=function(t,e,n){n=[];for(var i=[],r=new BinaryHeap(function(t){return 1/t.weight}),o=0;o<t.length;o++){var s=t[o];if(s.initialized()){s.numVisibleNodes=0,s.numVisiblePoints=0,s.deepestVisibleLevel=0,s.visibleNodes=[],s.visibleGeometry=[],e.updateMatrixWorld();var a=new THREE.Frustum,u=e.matrixWorldInverse,l=s.matrixWorld,d=e.clone();for(d.near=e.near,d.updateProjectionMatrix(),d=e.projectionMatrix,u=(new THREE.Matrix4).multiply(d).multiply(u).multiply(l),a.setFromMatrix(u),n.push(a),a=e.matrixWorld,l=(new THREE.Matrix4).getInverse(l),l=(new THREE.Matrix4).multiply(l).multiply(a),l=(new THREE.Vector3).setFromMatrixPosition(l),i.push(l),s.visible&&null!==s.root&&r.push({pointcloud:o,node:s.root,weight:Number.MAX_VALUE}),s.root.isTreeNode()&&s.hideDescendants(s.root.sceneNode),l=0;l<s.boundingBoxNodes.length;l++)s.boundingBoxNodes[l].visible=!1}}return{frustums:n,camObjPositions:i,priorityQueue:r}},Potree.shuffleArray=function(t){for(var e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1)),i=t[e];t[e]=t[n],t[n]=i}},Potree.paramThreeToGL=function(t,e){if(e===THREE.RepeatWrapping)return t.REPEAT;if(e===THREE.ClampToEdgeWrapping)return t.CLAMP_TO_EDGE;if(e===THREE.MirroredRepeatWrapping)return t.MIRRORED_REPEAT;if(e===THREE.NearestFilter)return t.NEAREST;if(e===THREE.NearestMipMapNearestFilter)return t.NEAREST_MIPMAP_NEAREST;if(e===THREE.NearestMipMapLinearFilter)return t.NEAREST_MIPMAP_LINEAR;if(e===THREE.LinearFilter)return t.LINEAR;if(e===THREE.LinearMipMapNearestFilter)return t.LINEAR_MIPMAP_NEAREST;if(e===THREE.LinearMipMapLinearFilter)return t.LINEAR_MIPMAP_LINEAR;if(e===THREE.UnsignedByteType)return t.UNSIGNED_BYTE;if(e===THREE.UnsignedShort4444Type)return t.UNSIGNED_SHORT_4_4_4_4;if(e===THREE.UnsignedShort5551Type)return t.UNSIGNED_SHORT_5_5_5_1;if(e===THREE.UnsignedShort565Type)return t.UNSIGNED_SHORT_5_6_5;if(e===THREE.ByteType)return t.BYTE;if(e===THREE.ShortType)return t.SHORT;if(e===THREE.UnsignedShortType)return t.UNSIGNED_SHORT;if(e===THREE.IntType)return t.INT;if(e===THREE.UnsignedIntType)return t.UNSIGNED_INT;if(e===THREE.FloatType)return t.FLOAT;if(e===THREE.HalfFloatType){var n=extensions.get("OES_texture_half_float");if(null!==n)return n.HALF_FLOAT_OES}if(e===THREE.AlphaFormat)return t.ALPHA;if(e===THREE.RGBFormat)return t.RGB;if(e===THREE.RGBAFormat)return t.RGBA;if(e===THREE.LuminanceFormat)return t.LUMINANCE;if(e===THREE.LuminanceAlphaFormat)return t.LUMINANCE_ALPHA;if(e===THREE.DepthFormat)return t.DEPTH_COMPONENT;if(e===THREE.DepthStencilFormat)return t.DEPTH_STENCIL;if(e===THREE.AddEquation)return t.FUNC_ADD;if(e===THREE.SubtractEquation)return t.FUNC_SUBTRACT;if(e===THREE.ReverseSubtractEquation)return t.FUNC_REVERSE_SUBTRACT;if(e===THREE.ZeroFactor)return t.ZERO;if(e===THREE.OneFactor)return t.ONE;if(e===THREE.SrcColorFactor)return t.SRC_COLOR;if(e===THREE.OneMinusSrcColorFactor)return t.ONE_MINUS_SRC_COLOR;if(e===THREE.SrcAlphaFactor)return t.SRC_ALPHA;if(e===THREE.OneMinusSrcAlphaFactor)return t.ONE_MINUS_SRC_ALPHA;if(e===THREE.DstAlphaFactor)return t.DST_ALPHA;if(e===THREE.OneMinusDstAlphaFactor)return t.ONE_MINUS_DST_ALPHA;if(e===THREE.DstColorFactor)return t.DST_COLOR;if(e===THREE.OneMinusDstColorFactor)return t.ONE_MINUS_DST_COLOR;if(e===THREE.SrcAlphaSaturateFactor)return t.SRC_ALPHA_SATURATE;if((e===THREE.RGB_S3TC_DXT1_Format||e===RGBA_S3TC_DXT1_Format||e===THREE.RGBA_S3TC_DXT3_Format||e===RGBA_S3TC_DXT5_Format)&&null!==(n=extensions.get("WEBGL_compressed_texture_s3tc"))){if(e===THREE.RGB_S3TC_DXT1_Format)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===THREE.RGBA_S3TC_DXT1_Format)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===THREE.RGBA_S3TC_DXT3_Format)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===THREE.RGBA_S3TC_DXT5_Format)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((e===THREE.RGB_PVRTC_4BPPV1_Format||e===THREE.RGB_PVRTC_2BPPV1_Format||e===THREE.RGBA_PVRTC_4BPPV1_Format||e===THREE.RGBA_PVRTC_2BPPV1_Format)&&null!==(n=extensions.get("WEBGL_compressed_texture_pvrtc"))){if(e===THREE.RGB_PVRTC_4BPPV1_Format)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===THREE.RGB_PVRTC_2BPPV1_Format)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===THREE.RGBA_PVRTC_4BPPV1_Format)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===THREE.RGBA_PVRTC_2BPPV1_Format)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===THREE.RGB_ETC1_Format&&null!==(n=extensions.get("WEBGL_compressed_texture_etc1")))return n.COMPRESSED_RGB_ETC1_WEBGL;if((e===THREE.MinEquation||e===THREE.MaxEquation)&&null!==(n=extensions.get("EXT_blend_minmax"))){if(e===THREE.MinEquation)return n.MIN_EXT;if(e===THREE.MaxEquation)return n.MAX_EXT}return e===UnsignedInt248Type&&null!==(n=extensions.get("WEBGL_depth_texture"))?n.UNSIGNED_INT_24_8_WEBGL:0},Potree.PointAttributeNames={POSITION_CARTESIAN:0,COLOR_PACKED:1,COLOR_FLOATS_1:2,COLOR_FLOATS_255:3,NORMAL_FLOATS:4,FILLER:5,INTENSITY:6,CLASSIFICATION:7,NORMAL_SPHEREMAPPED:8,NORMAL_OCT16:9,NORMAL:10,RETURN_NUMBER:11,NUMBER_OF_RETURNS:12,SOURCE_ID:13,INDICES:14,SPACING:15},Potree.PointAttributeTypes={DATA_TYPE_DOUBLE:{ordinal:0,size:8},DATA_TYPE_FLOAT:{ordinal:1,size:4},DATA_TYPE_INT8:{ordinal:2,size:1},DATA_TYPE_UINT8:{ordinal:3,size:1},DATA_TYPE_INT16:{ordinal:4,size:2},DATA_TYPE_UINT16:{ordinal:5,size:2},DATA_TYPE_INT32:{ordinal:6,size:4},DATA_TYPE_UINT32:{ordinal:7,size:4},DATA_TYPE_INT64:{ordinal:8,size:8},DATA_TYPE_UINT64:{ordinal:9,size:8}};var obj,i=0;for(obj in Potree.PointAttributeTypes)Potree.PointAttributeTypes[i]=Potree.PointAttributeTypes[obj],i++;Potree.PointAttribute=function(t,e,n){this.name=t,this.type=e,this.numElements=n,this.byteSize=this.numElements*this.type.size},Potree.PointAttribute.POSITION_CARTESIAN=new Potree.PointAttribute(Potree.PointAttributeNames.POSITION_CARTESIAN,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttribute.RGBA_PACKED=new Potree.PointAttribute(Potree.PointAttributeNames.COLOR_PACKED,Potree.PointAttributeTypes.DATA_TYPE_INT8,4),Potree.PointAttribute.COLOR_PACKED=Potree.PointAttribute.RGBA_PACKED,Potree.PointAttribute.RGB_PACKED=new Potree.PointAttribute(Potree.PointAttributeNames.COLOR_PACKED,Potree.PointAttributeTypes.DATA_TYPE_INT8,3),Potree.PointAttribute.NORMAL_FLOATS=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_FLOATS,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttribute.FILLER_1B=new Potree.PointAttribute(Potree.PointAttributeNames.FILLER,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.INTENSITY=new Potree.PointAttribute(Potree.PointAttributeNames.INTENSITY,Potree.PointAttributeTypes.DATA_TYPE_UINT16,1),Potree.PointAttribute.CLASSIFICATION=new Potree.PointAttribute(Potree.PointAttributeNames.CLASSIFICATION,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.NORMAL_SPHEREMAPPED=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_SPHEREMAPPED,Potree.PointAttributeTypes.DATA_TYPE_UINT8,2),Potree.PointAttribute.NORMAL_OCT16=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_OCT16,Potree.PointAttributeTypes.DATA_TYPE_UINT8,2),Potree.PointAttribute.NORMAL=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttribute.RETURN_NUMBER=new Potree.PointAttribute(Potree.PointAttributeNames.RETURN_NUMBER,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.NUMBER_OF_RETURNS=new Potree.PointAttribute(Potree.PointAttributeNames.NUMBER_OF_RETURNS,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.SOURCE_ID=new Potree.PointAttribute(Potree.PointAttributeNames.SOURCE_ID,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.INDICES=new Potree.PointAttribute(Potree.PointAttributeNames.INDICES,Potree.PointAttributeTypes.DATA_TYPE_UINT32,1),Potree.PointAttribute.SPACING=new Potree.PointAttribute(Potree.PointAttributeNames.SPACING,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,1),Potree.PointAttributes=function(t){if(this.attributes=[],this.size=this.byteSize=0,null!=t)for(var e=0;e<t.length;e++){var n=Potree.PointAttribute[t[e]];this.attributes.push(n),this.byteSize+=n.byteSize,this.size++}},Potree.PointAttributes.prototype.add=function(t){this.attributes.push(t),this.byteSize+=t.byteSize,this.size++},Potree.PointAttributes.prototype.hasColors=function(){for(var t in this.attributes)if(this.attributes[t].name===Potree.PointAttributeNames.COLOR_PACKED)return!0;return!1},Potree.PointAttributes.prototype.hasNormals=function(){for(var t in this.attributes){var e=this.attributes[t];if(e===Potree.PointAttribute.NORMAL_SPHEREMAPPED||e===Potree.PointAttribute.NORMAL_FLOATS||e===Potree.PointAttribute.NORMAL||e===Potree.PointAttribute.NORMAL_OCT16)return!0}return!1};var PotreeGradients={RAINBOW:[[0,new THREE.Color(.278,0,.714)],[1/6,new THREE.Color(0,0,1)],[2/6,new THREE.Color(0,1,1)],[.5,new THREE.Color(0,1,0)],[4/6,new THREE.Color(1,1,0)],[5/6,new THREE.Color(1,.64,0)],[1,new THREE.Color(1,0,0)]],SPECTRAL:[[0,new THREE.Color(.3686,.3098,.6353)],[.1,new THREE.Color(.1961,.5333,.7412)],[.2,new THREE.Color(.4,.7608,.6471)],[.3,new THREE.Color(.6706,.8667,.6431)],[.4,new THREE.Color(.902,.9608,.5961)],[.5,new THREE.Color(1,1,.749)],[.6,new THREE.Color(.9961,.8784,.5451)],[.7,new THREE.Color(.9922,.6824,.3804)],[.8,new THREE.Color(.9569,.4275,.2627)],[.9,new THREE.Color(.8353,.2431,.3098)],[1,new THREE.Color(.6196,.0039,.2588)]],PLASMA:[[0,new THREE.Color(.241,.015,.61)],[.1,new THREE.Color(.387,.001,.654)],[.2,new THREE.Color(.524,.025,.653)],[.3,new THREE.Color(.651,.125,.596)],[.4,new THREE.Color(.752,.227,.513)],[.5,new THREE.Color(.837,.329,.431)],[.6,new THREE.Color(.907,.435,.353)],[.7,new THREE.Color(.963,.554,.272)],[.8,new THREE.Color(.992,.681,.195)],[.9,new THREE.Color(.987,.822,.144)],[1,new THREE.Color(.94,.975,.131)]],YELLOW_GREEN:[[0,new THREE.Color(.1647,.2824,.3451)],[.1,new THREE.Color(.1338,.3555,.4227)],[.2,new THREE.Color(.061,.4319,.4864)],[.3,new THREE.Color(0,.5099,.5319)],[.4,new THREE.Color(0,.5881,.5569)],[.5,new THREE.Color(.137,.665,.5614)],[.6,new THREE.Color(.2906,.7395,.5477)],[.7,new THREE.Color(.4453,.8099,.5201)],[.8,new THREE.Color(.6102,.8748,.485)],[.9,new THREE.Color(.7883,.9323,.4514)],[1,new THREE.Color(.9804,.9804,.4314)]],VIRIDIS:[[0,new THREE.Color(.267,.005,.329)],[.1,new THREE.Color(.283,.141,.458)],[.2,new THREE.Color(.254,.265,.53)],[.3,new THREE.Color(.207,.372,.553)],[.4,new THREE.Color(.164,.471,.558)],[.5,new THREE.Color(.128,.567,.551)],[.6,new THREE.Color(.135,.659,.518)],[.7,new THREE.Color(.267,.749,.441)],[.8,new THREE.Color(.478,.821,.318)],[.9,new THREE.Color(.741,.873,.15)],[1,new THREE.Color(.993,.906,.144)]],INFERNO:[[0,new THREE.Color(.077,.042,.206)],[.1,new THREE.Color(.225,.036,.388)],[.2,new THREE.Color(.373,.074,.432)],[.3,new THREE.Color(.522,.128,.42)],[.4,new THREE.Color(.665,.182,.37)],[.5,new THREE.Color(.797,.255,.287)],[.6,new THREE.Color(.902,.364,.184)],[.7,new THREE.Color(.969,.516,.063)],[.8,new THREE.Color(.988,.683,.072)],[.9,new THREE.Color(.961,.859,.298)],[1,new THREE.Color(.988,.998,.645)]],GRAYSCALE:[[0,new THREE.Color(0,0,0)],[1,new THREE.Color(1,1,1)]]};function PotreeShaders(){}Potree.Points=class{constructor(){this.boundingBox=new THREE.Box3,this.numPoints=0,this.data={}}add(t){var e,n=this.numPoints,i=n+t.numPoints,r=Object.keys(this.data),o=Object.keys(t.data),s=new Set([...r,...o]);for(e of s)if(r.includes(e)&&o.includes(e)){var a=this.data[e].constructor;(s=new a(this.data[e].length+t.data[e].length)).set(this.data[e],0),s.set(t.data[e],this.data[e].length),this.data[e]=s}else r.includes(e)&&!o.includes(e)?(s=this.data[e].length/this.numPoints,(a=new(a=this.data[e].constructor)(s*i)).set(this.data[e],0),this.data[e]=a):!r.includes(e)&&o.includes(e)&&(s=t.data[e].length/t.numPoints,(a=new(a=t.data[e].constructor)(s*i)).set(t.data[e],s*n),this.data[e]=a);this.numPoints=i,this.boundingBox.union(t.boundingBox)}},Potree.Shader=class{constructor(t,e,n,i){this.gl=t,this.name=e,this.vsSource=n,this.fsSource=i,this.cache=new Map,this.program=this.fs=this.vs=null,this.uniformLocations={},this.attributeLocations={},this.update(n,i)}update(t,e){this.vsSource=t,this.fsSource=e,this.linkProgram()}compileShader(t,e){var n=this.gl;if(n.shaderSource(t,e),n.compileShader(t),!n.getShaderParameter(t,n.COMPILE_STATUS))throw t=n.getShaderInfoLog(t),Error("Potree: Could not compile shader "+this.name+", "+t)}linkProgram(){var t=this.gl;this.uniformLocations={},this.attributeLocations={},t.useProgram(null);var e=this.cache.get(`${this.vsSource}, ${this.fsSource}`);if(e)this.program=e.program,this.vs=e.vs,this.fs=e.fs,this.attributeLocations=e.attributeLocations,this.uniformLocations=e.uniformLocations;else{for(var n of(this.vs=t.createShader(t.VERTEX_SHADER),this.fs=t.createShader(t.FRAGMENT_SHADER),this.program=t.createProgram(),Object.keys(Potree.attributeLocations)))e=Potree.attributeLocations[n],t.bindAttribLocation(this.program,e,n);if(this.compileShader(this.vs,this.vsSource),this.compileShader(this.fs,this.fsSource),n=this.program,t.attachShader(n,this.vs),t.attachShader(n,this.fs),t.linkProgram(n),t.detachShader(n,this.vs),t.detachShader(n,this.fs),!t.getProgramParameter(n,t.LINK_STATUS))throw t=t.getProgramInfoLog(n),Error("Potree: Could not link program "+this.name+", "+t);for(var i=t.getProgramParameter(n,t.ACTIVE_ATTRIBUTES),r=0;r<i;r++){var o=t.getActiveAttrib(n,r);e=t.getAttribLocation(n,o.name),this.attributeLocations[o.name]=e}for(i=t.getProgramParameter(n,t.ACTIVE_UNIFORMS),r=0;r<i;r++)o=t.getActiveUniform(n,r),e=t.getUniformLocation(n,o.name),this.uniformLocations[o.name]=e;e={program:this.program,vs:this.vs,fs:this.fs,attributeLocations:this.attributeLocations,uniformLocations:this.uniformLocations},this.cache.set(`${this.vsSource}, ${this.fsSource}`,e)}}setUniformMatrix4(t,e){const n=this.gl;null!=(t=this.uniformLocations[t])&&(e=new Float32Array(e.elements),n.uniformMatrix4fv(t,!1,e))}setUniform1f(t,e){null!=(t=this.uniformLocations[t])&&this.gl.uniform1f(t,e)}setUniformBoolean(t,e){null!=(t=this.uniformLocations[t])&&this.gl.uniform1i(t,e)}setUniformTexture(t,e){null!=(t=this.uniformLocations[t])&&this.gl.uniform1i(t,e)}setUniform2f(t,e){null!=(t=this.uniformLocations[t])&&this.gl.uniform2f(t,e[0],e[1])}setUniform3f(t,e){null!=(t=this.uniformLocations[t])&&this.gl.uniform3f(t,e[0],e[1],e[2])}setUniform(t,e){e.constructor===THREE.Matrix4?this.setUniformMatrix4(t,e):"number"==typeof e?this.setUniform1f(t,e):"boolean"==typeof e?this.setUniformBoolean(t,e):e instanceof Potree.WebGLTexture?this.setUniformTexture(t,e):e instanceof Array?2===e.length?this.setUniform2f(t,e):3===e.length&&this.setUniform3f(t,e):console.error("Potree: Unhandled uniform type: ",t,e)}setUniform1i(t,e){null!=(t=this.uniformLocations[t])&&this.gl.uniform1i(t,e)}},Potree.WebGLTexture=class{constructor(t,e){this.gl=t,this.texture=e,this.id=t.createTexture(),this.target=t.TEXTURE_2D,this.version=-1,this.update(e)}update(){if(this.texture.image){var t=this.gl,e=this.texture;if(this.version!==e.version){this.target=t.TEXTURE_2D,t.bindTexture(this.target,this.id);var n=Potree.paramThreeToGL(t,e.format),i=e.image.width,r=e.image.height,o=Potree.paramThreeToGL(t,e.type);if(t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,e.unpackAlignment),e instanceof THREE.DataTexture){var s=e.image.data;t.texParameteri(this.target,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(this.target,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,Potree.paramThreeToGL(t,e.magFilter)),t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,Potree.paramThreeToGL(t,e.minFilter)),t.texImage2D(this.target,0,n,i,r,0,n,o,s)}else e instanceof THREE.CanvasTexture&&(s=e.image,t.texParameteri(this.target,t.TEXTURE_WRAP_S,Potree.paramThreeToGL(t,e.wrapS)),t.texParameteri(this.target,t.TEXTURE_WRAP_T,Potree.paramThreeToGL(t,e.wrapT)),t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,Potree.paramThreeToGL(t,e.magFilter)),t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,Potree.paramThreeToGL(t,e.minFilter)),t.texImage2D(this.target,0,n,n,o,s));t.bindTexture(this.target,null),this.version=e.version}}else this.version=this.texture.version}},Potree.WebGLBuffer=class{constructor(){this.numElements=0,this.vao=null,this.vbos=new Map}},PotreeShaders["pointcloud.vs"]="\nprecision highp float;\nprecision highp int;\n\n#define max_clip_polygons 8\n#define PI 3.141592653589793\n\n"+THREE.ShaderChunk.logdepthbuf_pars_vertex+"\n\nattribute vec3 position;\nattribute vec3 color;\nattribute float intensity;\nattribute float classification;\nattribute float returnNumber;\nattribute float numberOfReturns;\nattribute float pointSourceID;\nattribute vec4 indices;\nattribute float spacing;\n\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 uViewInv;\n\nuniform float uScreenWidth;\nuniform float uScreenHeight;\nuniform float fov;\nuniform float near;\nuniform float far;\n\nuniform bool uDebug;\n\nuniform bool uUseOrthographicCamera;\nuniform float uOrthoWidth;\nuniform float uOrthoHeight;\n\n#define CLIPTASK_NONE 0\n#define CLIPTASK_HIGHLIGHT 1\n#define CLIPTASK_SHOW_INSIDE 2\n#define CLIPTASK_SHOW_OUTSIDE 3\n\n#define CLIPMETHOD_INSIDE_ANY 0\n#define CLIPMETHOD_INSIDE_ALL 1\n\nuniform int clipTask;\nuniform int clipMethod;\n\n#if defined(num_clipboxes) && num_clipboxes > 0\n\tuniform mat4 clipBoxes[num_clipboxes];\n#endif\n\n#if defined(num_clipspheres) && num_clipspheres > 0\n\tuniform mat4 uClipSpheres[num_clipspheres];\n#endif\n\n#if defined(num_clippolygons) && num_clippolygons > 0\n\tuniform int uClipPolygonVCount[num_clippolygons];\n\tuniform vec3 uClipPolygonVertices[num_clippolygons * 8];\n\tuniform mat4 uClipPolygonWVP[num_clippolygons];\n#endif\n\nuniform float size;\nuniform float minSize;\nuniform float maxSize;\n\nuniform float uPCIndex;\nuniform float uOctreeSpacing;\nuniform float uNodeSpacing;\nuniform float uOctreeSize;\nuniform vec3 uBBSize;\nuniform float uLevel;\nuniform float uVNStart;\nuniform bool uIsLeafNode;\n\nuniform vec3 uColor;\nuniform float uOpacity;\n\nuniform vec2 elevationRange;\nuniform vec2 intensityRange;\nuniform float intensityGamma;\nuniform float intensityContrast;\nuniform float intensityBrightness;\nuniform float rgbGamma;\nuniform float rgbContrast;\nuniform float rgbBrightness;\nuniform float uTransition;\nuniform float wRGB;\nuniform float wIntensity;\nuniform float wElevation;\nuniform float wClassification;\nuniform float wReturnNumber;\nuniform float wSourceID;\n\nuniform vec3 uShadowColor;\n\nuniform sampler2D visibleNodes;\nuniform sampler2D gradient;\nuniform sampler2D classificationLUT;\n\n#if defined(num_shadowmaps) && num_shadowmaps > 0\n\tuniform sampler2D uShadowMap[num_shadowmaps];\n\tuniform mat4 uShadowWorldView[num_shadowmaps];\n\tuniform mat4 uShadowProj[num_shadowmaps];\n#endif\n\nvarying vec3 vColor;\nvarying float vLogDepth;\nvarying vec3 vViewPosition;\nvarying float vRadius;\nvarying float vPointSize;\n\nfloat round(float number)\n{\n\treturn floor(number + 0.5);\n}\n\n//---------------------\n//OCTREE\n//---------------------\n\n#if (defined(adaptive_point_size) || defined(color_type_lod)) && defined(tree_type_octree)\n\n\t/**\n\t * number of 1-bits up to inclusive index position\n\t * number is treated as if it were an integer in the range 0-255\n\t */\n\tint numberOfOnes(int number, int index)\n\t{\n\t\tint numOnes = 0;\n\t\tint tmp = 128;\n\n\t\tfor(int i = 7; i >= 0; i--)\n\t\t{\n\t\t\tif(number >= tmp)\n\t\t\t{\n\t\t\t\tnumber = number - tmp;\n\n\t\t\t\tif(i <= index)\n\t\t\t\t{\n\t\t\t\t\tnumOnes++;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\ttmp = tmp / 2;\n\t\t}\n\n\t\treturn numOnes;\n\t}\n\n\t/**\n\t * checks whether the bit at index is 1\n\t * number is treated as if it were an integer in the range 0-255\n\t */\n\tbool isBitSet(int number, int index)\n\t{\n\t\t//weird multi else if due to lack of proper array, int and bitwise support in WebGL 1.0\n\t\tint powi = 1;\n\n\t\tif(index == 0)\n\t\t{\n\t\t\tpowi = 1;\n\t\t}\n\t\telse if(index == 1)\n\t\t{\n\t\t\tpowi = 2;\n\t\t}\n\t\telse if(index == 2)\n\t\t{\n\t\t\tpowi = 4;\n\t\t}\n\t\telse if(index == 3)\n\t\t{\n\t\t\tpowi = 8;\n\t\t}\n\t\telse if(index == 4)\n\t\t{\n\t\t\tpowi = 16;\n\t\t}\n\t\telse if(index == 5)\n\t\t{\n\t\t\tpowi = 32;\n\t\t}\n\t\telse if(index == 6)\n\t\t{\n\t\t\tpowi = 64;\n\t\t}\n\t\telse if(index == 7)\n\t\t{\n\t\t\tpowi = 128;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tint ndp = number / powi;\n\n\t\treturn mod(float(ndp), 2.0) != 0.0;\n\t}\n\n\t/**\n\t * find the LOD at the point position\n\t */\n\tfloat getLOD()\n\t{\n\t\tvec3 offset = vec3(0.0, 0.0, 0.0);\n\t\tint iOffset = int(uVNStart);\n\t\tfloat depth = uLevel;\n\n\t\tfor(float i = 0.0; i <= 30.0; i++)\n\t\t{\n\t\t\tfloat nodeSizeAtLevel = uOctreeSize / pow(2.0, i + uLevel + 0.0);\n\t\t\t\n\t\t\tvec3 index3d = (position-offset) / nodeSizeAtLevel;\n\t\t\tindex3d = floor(index3d + 0.5);\n\t\t\tint index = int(round(4.0 * index3d.x + 2.0 * index3d.y + index3d.z));\n\t\t\t\n\t\t\tvec4 value = texture2D(visibleNodes, vec2(float(iOffset) / 2048.0, 0.0));\n\t\t\tint mask = int(round(value.r * 255.0));\n\n\t\t\tif(isBitSet(mask, index))\n\t\t\t{\n\t\t\t\t//there are more visible child nodes at this position\n\t\t\t\tint advanceG = int(round(value.g * 255.0)) * 256;\n\t\t\t\tint advanceB = int(round(value.b * 255.0));\n\t\t\t\tint advanceChild = numberOfOnes(mask, index - 1);\n\t\t\t\tint advance = advanceG + advanceB + advanceChild;\n\n\t\t\t\tiOffset = iOffset + advance;\n\t\t\t\t\n\t\t\t\tdepth++;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t//no more visible child nodes at this position\n\t\t\t\treturn value.a * 255.0;\n\t\t\t\t//return depth;\n\t\t\t}\n\t\t\t\n\t\t\toffset = offset + (vec3(1.0, 1.0, 1.0) * nodeSizeAtLevel * 0.5) * index3d;\n\t\t}\n\t\t\t\n\t\treturn depth;\n\t}\n\n\tfloat getSpacing()\n\t{\n\t\tvec3 offset = vec3(0.0, 0.0, 0.0);\n\t\tint iOffset = int(uVNStart);\n\t\tfloat depth = uLevel;\n\t\tfloat spacing = uNodeSpacing;\n\n\t\tfor(float i = 0.0; i <= 30.0; i++)\n\t\t{\n\t\t\tfloat nodeSizeAtLevel = uOctreeSize / pow(2.0, i + uLevel + 0.0);\n\t\t\t\n\t\t\tvec3 index3d = (position-offset) / nodeSizeAtLevel;\n\t\t\tindex3d = floor(index3d + 0.5);\n\t\t\tint index = int(round(4.0 * index3d.x + 2.0 * index3d.y + index3d.z));\n\t\t\t\n\t\t\tvec4 value = texture2D(visibleNodes, vec2(float(iOffset) / 2048.0, 0.0));\n\t\t\tint mask = int(round(value.r * 255.0));\n\t\t\tfloat spacingFactor = value.a;\n\n\t\t\tif(i > 0.0)\n\t\t\t{\n\t\t\t\tspacing = spacing / (255.0 * spacingFactor);\n\t\t\t}\n\t\t\t\n\t\t\tif(isBitSet(mask, index))\n\t\t\t{\n\t\t\t\t//there are more visible child nodes at this position\n\t\t\t\tint advanceG = int(round(value.g * 255.0)) * 256;\n\t\t\t\tint advanceB = int(round(value.b * 255.0));\n\t\t\t\tint advanceChild = numberOfOnes(mask, index - 1);\n\t\t\t\tint advance = advanceG + advanceB + advanceChild;\n\n\t\t\t\tiOffset = iOffset + advance;\n\n\t\t\t\tdepth++;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t//no more visible child nodes at this position\n\t\t\t\treturn spacing;\n\t\t\t}\n\t\t\t\n\t\t\toffset = offset + (vec3(1.0, 1.0, 1.0) * nodeSizeAtLevel * 0.5) * index3d;\n\t\t}\n\t\t\t\n\t\treturn spacing;\n\t}\n\n\tfloat getPointSizeAttenuation()\n\t{\n\t\treturn pow(2.0, getLOD());\n\t}\n#endif\n\n//---------------------\n//KD-TREE\n//---------------------\n#if (defined(adaptive_point_size) || defined(color_type_lod)) && defined(tree_type_kdtree)\n\tfloat getLOD()\n\t{\n\t\tvec3 offset = vec3(0.0, 0.0, 0.0);\n\t\tfloat iOffset = 0.0;\n\t\tfloat depth = 0.0;\n\t\t\t\n\t\tvec3 size = uBBSize;\t\n\t\tvec3 pos = position;\n\t\t\t\n\t\tfor(float i = 0.0; i <= 1000.0; i++)\n\t\t{\n\t\t\tvec4 value = texture2D(visibleNodes, vec2(iOffset / 2048.0, 0.0));\n\t\t\t\n\t\t\tint children = int(value.r * 255.0);\n\t\t\tfloat next = value.g * 255.0;\n\t\t\tint split = int(value.b * 255.0);\n\t\t\t\n\t\t\tif(next == 0.0)\n\t\t\t{\n\t\t\t \treturn depth;\n\t\t\t}\n\t\t\t\n\t\t\tvec3 splitv = vec3(0.0, 0.0, 0.0);\n\t\t\tif(split == 1)\n\t\t\t{\n\t\t\t\tsplitv.x = 1.0;\n\t\t\t}\n\t\t\telse if(split == 2)\n\t\t\t{\n\t\t\t \tsplitv.y = 1.0;\n\t\t\t}\n\t\t\telse if(split == 4)\n\t\t\t{\n\t\t\t \tsplitv.z = 1.0;\n\t\t\t}\n\t\t\t\n\t\t\tiOffset = iOffset + next;\n\t\t\t\n\t\t\tfloat factor = length(pos * splitv / size);\n\n\t\t\t//Left\n\t\t\tif(factor < 0.5)\n\t\t\t{\n\t\t\t\tif(children == 0 || children == 2)\n\t\t\t\t{\n\t\t\t\t\treturn depth;\n\t\t\t\t}\n\t\t\t}\n\t\t\t//Right\n\t\t\telse\n\t\t\t{\n\t\t\t\tpos = pos - size * splitv * 0.5;\n\t\t\t\tif(children == 0 || children == 1)\n\t\t\t\t{\n\t\t\t\t\treturn depth;\n\t\t\t\t}\n\t\t\t\tif(children == 3)\n\t\t\t\t{\n\t\t\t\t\tiOffset = iOffset + 1.0;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsize = size * ((1.0 - (splitv + 1.0) / 2.0) + 0.5);\n\t\t\tdepth++;\n\t\t}\n\t\t\t\n\t\treturn depth;\t\n\t}\n\n\tfloat getPointSizeAttenuation()\n\t{\n\t\treturn 0.5 * pow(1.3, getLOD());\n\t}\n#endif\n\n//formula adapted from: http://www.dfstudios.co.uk/articles/programming/image-programming-algorithms/image-processing-algorithms-part-5-contrast-adjustment/\nfloat getContrastFactor(float contrast)\n{\n\treturn (1.0158730158730156 * (contrast + 1.0)) / (1.0158730158730156 - contrast);\n}\n\nvec3 getRGB()\n{\n\tvec3 rgb = color;\n\t\n\trgb = pow(rgb, vec3(rgbGamma));\n\trgb = rgb + rgbBrightness;\n\trgb = clamp(rgb, 0.0, 1.0);\n\t\n\treturn rgb;\n}\n\nfloat getIntensity()\n{\n\tfloat w = (intensity - intensityRange.x) / (intensityRange.y - intensityRange.x);\n\tw = pow(w, intensityGamma);\n\tw = w + intensityBrightness;\n\tw = (w - 0.5) * getContrastFactor(intensityContrast) + 0.5;\n\tw = clamp(w, 0.0, 1.0);\n\n\treturn w;\n}\n\nvec3 getElevation()\n{\n\tvec4 world = modelMatrix * vec4( position, 1.0 );\n\tfloat w = (world.z - elevationRange.x) / (elevationRange.y - elevationRange.x);\n\treturn texture2D(gradient, vec2(w,1.0-w)).rgb;\n}\n\nvec4 getClassification()\n{\n\tvec2 uv = vec2(classification / 255.0, 0.5);\n\treturn texture2D(classificationLUT, uv);\n}\n\nvec3 getReturnNumber()\n{\n\tif(numberOfReturns == 1.0)\n\t{\n\t\treturn vec3(1.0, 1.0, 0.0);\n\t}\n\telse\n\t{\n\t\tif(returnNumber == 1.0)\n\t\t{\n\t\t\treturn vec3(1.0, 0.0, 0.0);\n\t\t}\n\t\telse if(returnNumber == numberOfReturns)\n\t\t{\n\t\t\treturn vec3(0.0, 0.0, 1.0);\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn vec3(0.0, 1.0, 0.0);\n\t\t}\n\t}\n}\n\nvec3 getSourceID()\n{\n\tfloat w = mod(pointSourceID, 10.0) / 10.0;\n\treturn texture2D(gradient, vec2(w,1.0 - w)).rgb;\n}\n\nvec3 getCompositeColor()\n{\n\tvec3 c;\n\tfloat w;\n\n\tc += wRGB * getRGB();\n\tw += wRGB;\n\t\n\tc += wIntensity * getIntensity() * vec3(1.0, 1.0, 1.0);\n\tw += wIntensity;\n\t\n\tc += wElevation * getElevation();\n\tw += wElevation;\n\t\n\tc += wReturnNumber * getReturnNumber();\n\tw += wReturnNumber;\n\t\n\tc += wSourceID * getSourceID();\n\tw += wSourceID;\n\t\n\tvec4 cl = wClassification * getClassification();\n    c += cl.a * cl.rgb;\n\tw += wClassification * cl.a;\n\n\tc = c / w;\n\t\n\tif(w == 0.0)\n\t{\n\t\tgl_Position = vec4(100.0, 100.0, 100.0, 0.0);\n\t}\n\t\n\treturn c;\n}\n\nvec3 getColor()\n{\n\tvec3 color;\n\t\n\t#ifdef color_type_rgb\n\t\tcolor = getRGB();\n\t#elif defined color_type_height\n\t\tcolor = getElevation();\n\t#elif defined color_type_rgb_height\n\t\tvec3 cHeight = getElevation();\n\t\tcolor = (1.0 - uTransition) * getRGB() + uTransition * cHeight;\n\t#elif defined color_type_depth\n\t\tfloat linearDepth = gl_Position.w;\n\t\tfloat expDepth = (gl_Position.z / gl_Position.w) * 0.5 + 0.5;\n\t\tcolor = vec3(linearDepth, expDepth, 0.0);\n\t#elif defined color_type_intensity\n\t\tfloat w = getIntensity();\n\t\tcolor = vec3(w, w, w);\n\t#elif defined color_type_intensity_gradient\n\t\tfloat w = getIntensity();\n\t\tcolor = texture2D(gradient, vec2(w,1.0-w)).rgb;\n\t#elif defined color_type_color\n\t\tcolor = uColor;\n\t#elif defined color_type_lod\n\t\tfloat depth = getLOD();\n\t\tfloat w = depth / 10.0;\n\t\tcolor = texture2D(gradient, vec2(w,1.0-w)).rgb;\n\t#elif defined color_type_point_index\n\t\tcolor = indices.rgb;\n\t#elif defined color_type_classification\n\t\tvec4 cl = getClassification(); \n\t\tcolor = cl.rgb;\n\t#elif defined color_type_return_number\n\t\tcolor = getReturnNumber();\n\t#elif defined color_type_source\n\t\tcolor = getSourceID();\n\t#elif defined color_type_normal\n\t\tcolor = (modelMatrix * vec4(normal, 0.0)).xyz;\n\t#elif defined color_type_phong\n\t\tcolor = color;\n\t#elif defined color_type_composite\n\t\tcolor = getCompositeColor();\n\t#endif\n\t\n\treturn color;\n}\n\nfloat getPointSize()\n{\n\tfloat pointSize = 1.0;\n\t\n\tfloat slope = tan(fov / 2.0);\n\tfloat projFactor = -0.5 * uScreenHeight / (slope * vViewPosition.z);\n\t\n\tfloat r = uOctreeSpacing * 1.7;\n\tvRadius = r;\n\n\t#if defined fixed_point_size\n\t\tpointSize = size;\n\t#elif defined attenuated_point_size\n\t\tif(uUseOrthographicCamera)\n\t\t{\n\t\t\tpointSize = size;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tpointSize = size * spacing * projFactor;\n\t\t}\n\t#elif defined adaptive_point_size\n\t\tif(uUseOrthographicCamera)\n\t\t{\n\t\t\tfloat worldSpaceSize = 1.0 * size * r / getPointSizeAttenuation();\n\t\t\tpointSize = (worldSpaceSize / uOrthoWidth) * uScreenWidth;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif(uIsLeafNode && false)\n\t\t\t{\n\t\t\t\tpointSize = size * spacing * projFactor;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tfloat worldSpaceSize = 1.0 * size * r / getPointSizeAttenuation();\n\t\t\t\tpointSize = worldSpaceSize * projFactor;\n\t\t\t}\n\t\t}\n\t#endif\n\n\tpointSize = max(minSize, pointSize);\n\tpointSize = min(maxSize, pointSize);\n\t\n\tvRadius = pointSize / projFactor;\n\n\treturn pointSize;\n}\n\n#if defined num_clippolygons && num_clippolygons > 0\n\tbool pointInClipPolygon(vec3 point, int polyIdx)\n\t{\n\t\tmat4 wvp = uClipPolygonWVP[polyIdx];\n\n\t\tvec4 pointNDC = wvp * vec4(point, 1.0);\n\t\tpointNDC.xy = pointNDC.xy / pointNDC.w;\n\n\t\tint j = uClipPolygonVCount[polyIdx] - 1;\n\t\tbool c = false;\n\t\tfor(int i = 0; i < 8; i++)\n\t\t{\n\t\t\tif(i == uClipPolygonVCount[polyIdx])\n\t\t\t{\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tvec3 verti = uClipPolygonVertices[polyIdx * 8 + i];\n\t\t\tvec3 vertj = uClipPolygonVertices[polyIdx * 8 + j];\n\n\t\t\tif(((verti.y > pointNDC.y) != (vertj.y > pointNDC.y)) && (pointNDC.x < (vertj.x-verti.x) * (pointNDC.y-verti.y) / (vertj.y-verti.y) + verti.x))\n\t\t\t{\n\t\t\t\tc = !c;\n\t\t\t}\n\n\t\t\tj = i;\n\t\t}\n\n\t\treturn c;\n\t}\n#endif\n\nvoid doClipping()\n{\n\t#if !defined color_type_composite\n\t\tvec4 cl = getClassification(); \n\t\tif(cl.a == 0.0)\n\t\t{\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 0.0);\n\t\t\t\n\t\t\treturn;\n\t\t}\n\t#endif\n\n\tint clipVolumesCount = 0;\n\tint insideCount = 0;\n\n\t#if defined(num_clipboxes) && num_clipboxes > 0\n\t\tfor(int i = 0; i < num_clipboxes; i++)\n\t\t{\n\t\t\tvec4 clipPosition = clipBoxes[i] * modelMatrix * vec4( position, 1.0 );\n\t\t\tbool inside = -0.5 <= clipPosition.x && clipPosition.x <= 0.5;\n\t\t\tinside = inside && -0.5 <= clipPosition.y && clipPosition.y <= 0.5;\n\t\t\tinside = inside && -0.5 <= clipPosition.z && clipPosition.z <= 0.5;\n\n\t\t\tinsideCount = insideCount + (inside ? 1 : 0);\n\t\t\tclipVolumesCount++;\n\t\t}\t\n\t#endif\n\n\t#if defined(num_clippolygons) && num_clippolygons > 0\n\t\tfor(int i = 0; i < num_clippolygons; i++)\n\t\t{\n\t\t\tbool inside = pointInClipPolygon(position, i);\n\n\t\t\tinsideCount = insideCount + (inside ? 1 : 0);\n\t\t\tclipVolumesCount++;\n\t\t}\n\t#endif\n\n\tbool insideAny = insideCount > 0;\n\tbool insideAll = (clipVolumesCount > 0) && (clipVolumesCount == insideCount);\n\n\tif(clipMethod == CLIPMETHOD_INSIDE_ANY)\n\t{\n\t\tif(insideAny && clipTask == CLIPTASK_HIGHLIGHT)\n\t\t{\n\t\t\tvColor.r += 0.5;\n\t\t}\n\t\telse if(!insideAny && clipTask == CLIPTASK_SHOW_INSIDE)\n\t\t{\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 1.0);\n\t\t}\n\t\telse if(insideAny && clipTask == CLIPTASK_SHOW_OUTSIDE)\n\t\t{\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 1.0);\n\t\t}\n\t}\n\telse if(clipMethod == CLIPMETHOD_INSIDE_ALL)\n\t{\n\t\tif(insideAll && clipTask == CLIPTASK_HIGHLIGHT)\n\t\t{\n\t\t\tvColor.r += 0.5;\n\t\t}\n\t\telse if(!insideAll && clipTask == CLIPTASK_SHOW_INSIDE)\n\t\t{\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 1.0);\n\t\t}\n\t\telse if(insideAll && clipTask == CLIPTASK_SHOW_OUTSIDE)\n\t\t{\n\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 1.0);\n\t\t}\n\t}\n}\n\nvoid main()\n{\n\tvec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n\tvViewPosition = mvPosition.xyz;\n\tgl_Position = projectionMatrix * mvPosition;\n\n\tvLogDepth = log2(-mvPosition.z);\n\n\t//POINT SIZE\n\tfloat pointSize = getPointSize();\n\tgl_PointSize = pointSize;\n\tvPointSize = pointSize;\n\n\t"+THREE.ShaderChunk.logdepthbuf_vertex+"\n\n\t//COLOR\n\tvColor = getColor();\n\n\t#if defined hq_depth_pass\n\t\tfloat originalDepth = gl_Position.w;\n\t\tfloat adjustedDepth = originalDepth + 2.0 * vRadius;\n\t\tfloat adjust = adjustedDepth / originalDepth;\n\n\t\tmvPosition.xyz = mvPosition.xyz * adjust;\n\t\tgl_Position = projectionMatrix * mvPosition;\n\t#endif\n\n\t//CLIPPING\n\tdoClipping();\n\n\t#if defined num_clipspheres && num_clipspheres > 0\n\t\tfor(int i = 0; i < num_clipspheres; i++)\n\t\t{\n\t\t\tvec4 sphereLocal = uClipSpheres[i] * mvPosition;\n\n\t\t\tfloat distance = length(sphereLocal.xyz);\n\n\t\t\tif(distance < 1.0)\n\t\t\t{\n\t\t\t\tfloat w = distance;\n\t\t\t\tvec3 cGradient = texture2D(gradient, vec2(w, 1.0 - w)).rgb;\n\t\t\t\t\n\t\t\t\tvColor = cGradient;\n\t\t\t}\n\t\t}\n\t#endif\n\n\t#if defined num_shadowmaps && num_shadowmaps > 0\n\n\t\tconst float sm_near = 0.1;\n\t\tconst float sm_far = 10000.0;\n\n\t\tfor(int i = 0; i < num_shadowmaps; i++)\n\t\t{\n\t\t\tvec3 viewPos = (uShadowWorldView[i] * vec4(position, 1.0)).xyz;\n\t\t\tfloat distanceToLight = abs(viewPos.z);\n\t\t\t\n\t\t\tvec4 projPos = uShadowProj[i] * uShadowWorldView[i] * vec4(position, 1);\n\t\t\tvec3 nc = projPos.xyz / projPos.w;\n\t\t\t\n\t\t\tfloat u = nc.x * 0.5 + 0.5;\n\t\t\tfloat v = nc.y * 0.5 + 0.5;\n\n\t\t\tvec2 sampleStep = vec2(1.0 / (2.0*1024.0), 1.0 / (2.0*1024.0)) * 1.5;\n\t\t\tvec2 sampleLocations[9];\n\n\t\t\tsampleLocations[0] = vec2(0.0, 0.0);\n\t\t\tsampleLocations[1] = sampleStep;\n\t\t\tsampleLocations[2] = -sampleStep;\n\t\t\tsampleLocations[3] = vec2(sampleStep.x, -sampleStep.y);\n\t\t\tsampleLocations[4] = vec2(-sampleStep.x, sampleStep.y);\n\t\t\tsampleLocations[5] = vec2(0.0, sampleStep.y);\n\t\t\tsampleLocations[6] = vec2(0.0, -sampleStep.y);\n\t\t\tsampleLocations[7] = vec2(sampleStep.x, 0.0);\n\t\t\tsampleLocations[8] = vec2(-sampleStep.x, 0.0);\n\n\t\t\tfloat visibleSamples = 0.0;\n\t\t\tfloat numSamples = 0.0;\n\n\t\t\tfloat bias = vRadius * 2.0;\n\n\t\t\tfor(int j = 0; j < 9; j++)\n\t\t\t{\n\t\t\t\tvec4 depthMapValue = texture2D(uShadowMap[i], vec2(u, v) + sampleLocations[j]);\n\n\t\t\t\tfloat linearDepthFromSM = depthMapValue.x + bias;\n\t\t\t\tfloat linearDepthFromViewer = distanceToLight;\n\n\t\t\t\tif(linearDepthFromSM > linearDepthFromViewer)\n\t\t\t\t{\n\t\t\t\t\tvisibleSamples += 1.0;\n\t\t\t\t}\n\n\t\t\t\tnumSamples += 1.0;\n\t\t\t}\n\n\t\t\tfloat visibility = visibleSamples / numSamples;\n\n\t\t\tif(u < 0.0 || u > 1.0 || v < 0.0 || v > 1.0 || nc.x < -1.0 || nc.x > 1.0 || nc.y < -1.0 || nc.y > 1.0 || nc.z < -1.0 || nc.z > 1.0)\n\t\t\t{\n\t\t\t\t//vColor = vec3(0.0, 0.0, 0.2);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvColor = vColor * visibility + vColor * uShadowColor * (1.0 - visibility);\n\t\t\t}\n\t\t}\n\n\t#endif\n}",PotreeShaders["pointcloud.fs"]="\n\n#if defined USE_LOGDEPTHBUF_EXT || defined paraboloid_point_shape\n\t#extension GL_EXT_frag_depth : enable\n#endif\n\nprecision highp float;\nprecision highp int;\n\n"+THREE.ShaderChunk.logdepthbuf_pars_fragment+"\n\nuniform mat4 viewMatrix;\nuniform mat4 uViewInv;\nuniform mat4 uProjInv;\nuniform vec3 cameraPosition;\n\nuniform mat4 projectionMatrix;\nuniform float uOpacity;\n\nuniform float blendHardness;\nuniform float blendDepthSupplement;\nuniform float fov;\nuniform float uSpacing;\nuniform float near;\nuniform float far;\nuniform float uPCIndex;\nuniform float uScreenWidth;\nuniform float uScreenHeight;\n\nvarying vec3 vColor;\nvarying float vLogDepth;\nvarying vec3 vViewPosition;\nvarying float vRadius;\nvarying float vPointSize;\nvarying vec3 vPosition;\n\nvoid main()\n{\n\tvec3 color = vColor;\n\tfloat depth = gl_FragCoord.z;\n\n\t#if defined circle_point_shape || defined paraboloid_point_shape\n\t\tfloat u = (2.0 * gl_PointCoord.x) - 1.0;\n\t\tfloat v = (2.0 * gl_PointCoord.y) - 1.0;\n\t#endif\n\t\n\t#if defined circle_point_shape\n\t\tfloat cc = (u*u) + (v*v);\n\t\tif(cc > 1.0)\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n\n\t#if defined color_type_point_index\n\t\tgl_FragColor = vec4(color, uPCIndex / 255.0);\n\t#else\n\t\tgl_FragColor = vec4(color, uOpacity);\n\t#endif\n\n\t#if defined paraboloid_point_shape\n\t\tfloat wi = -( u*u + v*v);\n\t\tvec4 pos = vec4(vViewPosition, 1.0);\n\t\tpos.z += wi * vRadius;\n\t\tfloat linearDepth = -pos.z;\n\t\tpos = projectionMatrix * pos;\n\t\tpos = pos / pos.w;\n\t\tfloat expDepth = pos.z;\n\t\tdepth = (pos.z + 1.0) / 2.0;\n\n\t\tgl_FragDepthEXT = depth;\n\t\t\n\t\t#if defined color_type_depth\n\t\t\tcolor.r = linearDepth;\n\t\t\tcolor.g = expDepth;\n\t\t#endif\n\t#endif\n\t\n\t"+THREE.ShaderChunk.logdepthbuf_fragment+"\n\n\t#if defined weighted_splats\n\t\tfloat distance = 2.0 * length(gl_PointCoord.xy - 0.5);\n\t\tfloat weight = max(0.0, 1.0 - distance);\n\t\tweight = pow(weight, 1.5);\n\n\t\tgl_FragColor.a = weight;\n\t\tgl_FragColor.xyz = gl_FragColor.xyz * weight;\n\t#endif\n}";class PotreeDEM{constructor(t){this.pointcloud=t,this.boundingBox=this.matrix=null,this.tileSize=64,this.root=null,this.version=0}expandAndFindByBox(t,e){if(0===e)return[this.root];for(var n=[],i=[this.root];0<i.length;){var r=i.pop(),o=r.box.getSize(new THREE.Vector3),s=(t.min.x-r.box.min.x)/o.x,a=(t.min.y-r.box.min.y)/o.y,u=(t.max.x-r.box.max.x)/o.x,l=(t.max.y-r.box.max.y)/o.y;for(var d of(a=.5>a?0:1,u=.5>u?0:1,l=.5>l?0:1,s=0===(s=.5>s?0:1)&&0===a&&1===u&&1===l?[0,1,2,3]:s===u&&a===l?[s<<1|a]:[s<<1|a,u<<1|l]))void 0===r.children[d]&&(s=r.box.clone(),0<(2&d)?s.min.x+=o.x/2:s.max.x-=o.x/2,0<(1&d)?s.min.y+=o.y/2:s.max.y-=o.y/2,s=new PotreeDEMNode(r.name+d,s,this.tileSize),r.children[d]=s),(s=r.children[d]).level<e?i.push(s):n.push(s)}return n}childIndex(t){var[t,e]=t.map(t=>.5>t?0:1);return t<<1|e}height(t){if(!this.root)return 0;for(var e=null,n=[this.root];;){var i=n[n.length-1],r=i.height(t);if(null!==r&&(e=r),r=i.uv(t),r=this.childIndex(r),!i.children[r])break;n.push(i.children[r])}return e+this.pointcloud.position.z}update(t){null!==this.matrix&&this.matrix.equals(this.pointcloud.matrixWorld)||(this.matrix=this.pointcloud.matrixWorld.clone(),this.boundingBox=this.pointcloud.boundingBox.clone().applyMatrix4(this.matrix),this.root=new PotreeDEMNode("r",this.boundingBox,this.tileSize),this.version++);var e,n=null;for(e of t)if(void 0===e.demVersion||e.demVersion<this.version){n=e;break}if(null!==n){var i=n.getBoundingBox().clone().applyMatrix4(this.matrix),r=i.getSize(new THREE.Vector3),o=this.expandAndFindByBox(i,n.getLevel());n.demVersion=this.version,t=n.geometryNode.geometry.attributes.position.array,n={boundingBox:{min:n.getBoundingBox().min.toArray(),max:n.getBoundingBox().max.toArray()},position:new Float32Array(t).buffer};var s=this;Potree.workerPool.runTask(WorkerManager.DEM,function(t){for(var e of(t=new Float32Array(t.data.dem.data),o)){for(var n=e.box.getSize(new THREE.Vector3),a=0;a<s.tileSize;a++)for(var u=0;u<s.tileSize;u++){var l=s.tileSize*(e.box.min.x+a/(s.tileSize-1)*n.x-i.min.x)/r.x,d=s.tileSize*(e.box.min.y+u/(s.tileSize-1)*n.y-i.min.y)/r.y;0>l||l>s.tileSize||0>d||d>s.tileSize||(l=Math.min(Math.floor(l),s.tileSize-1),d=Math.min(Math.floor(d),s.tileSize-1),e.data[a+s.tileSize*u]=t[l+s.tileSize*d])}e.createMipMap(),e.mipMapNeedsUpdate=!0}},n,[n.position])}}}class PotreeDEMNode{constructor(t,e,n){this.name=t,this.box=e,this.tileSize=n,this.level=this.name.length-1,this.data=new Float32Array(n*n),this.data.fill(-1/0),this.children=[],this.mipMap=[this.data],this.mipMapNeedsUpdate=!0}createMipMap(){this.mipMap=[this.data];for(var t=this.tileSize,e=parseInt(t/2),n=this.data;1<e;){for(var i=new Float32Array(e*e),r=0;r<e;r++)for(var o=0;o<e;o++){var s=n[2*r+2*o*t],a=n[2*r+2*o*t+t],u=n[2*r+1+2*o*t],l=n[2*r+1+2*o*t+t],[d,h]=[0,0];isFinite(s)&&(d+=s,h+=1),isFinite(a)&&(d+=a,h+=1),isFinite(u)&&(d+=u,h+=1),isFinite(l)&&(d+=l,h+=1),d/=h,i[r+o*e]=d}this.mipMap.push(i),n=i,t=e,e=parseInt(e/2)}this.mipMapNeedsUpdate=!1}uv(t){var e=this.box.getSize(new THREE.Vector3);return[(t.x-this.box.min.x)/e.x,(t.y-this.box.min.y)/e.y]}heightAtMipMapLevel(t,e){t=this.uv(t);var n,i=parseInt(this.tileSize/parseInt(2**e)),r=this.mipMap[e];e=(n=Math.min(t[0]*i,i-1))%1;var o=(t=Math.min(t[1]*i,i-1))%1,[n,s]=[Math.floor(n),Math.ceil(n)],[a,u]=[Math.floor(t),Math.ceil(t)];return t=r[n+i*a],n=r[n+i*u],a=r[s+i*a],i=r[s+i*u],r=isFinite(t)?(1-e)*(1-o):0,r/=o=r+(s=isFinite(n)?(1-e)*o:0)+(u=isFinite(a)?e*(1-o):0)+(e=isFinite(i)?e*o:0),s/=o,u/=o,e/=o,0===o?null:(o=0,isFinite(t)&&(o+=t*r),isFinite(n)&&(o+=n*s),isFinite(a)&&(o+=a*u),isFinite(i)&&(o+=i*e),o)}height(t){for(var e=null,n=0;n<this.mipMap.length&&null===(e=this.heightAtMipMapLevel(t,n));n++);return e}traverse(t,e=0){for(var n of(t(this,e),this.children.filter(t=>void 0!==t)))n.traverse(t,e+1)}}class PointCloudTreeNode{constructor(){this.needsTransformUpdate=!0}getChildren(){}getBoundingBox(){}isLoaded(){}isGeometryNode(){}isTreeNode(){}getLevel(){}getBoundingSphere(){}}class PointCloudTree extends THREE.Object3D{constructor(){super(),this.dem=new PotreeDEM(this)}initialized(){return null!==this.root}}class PointCloudArena4DNode extends PointCloudTreeNode{constructor(){super(),this.kdtree=this.sceneNode=this.right=this.left=null}getNumPoints(){return this.geometryNode.numPoints}isLoaded(){return!0}isTreeNode(){return!0}isGeometryNode(){return!1}getLevel(){return this.geometryNode.level}getBoundingSphere(){return this.geometryNode.boundingSphere}getBoundingBox(){return this.geometryNode.boundingBox}toTreeNode(t){var e=null;if(this.left===t?e=this.left:this.right===t&&(e=this.right),e.loaded){t=new PointCloudArena4DNode;var n=THREE.PointCloud(e.geometry,this.kdtree.material);n.visible=!1,t.kdtree=this.kdtree,t.geometryNode=e,t.sceneNode=n,t.parent=this,t.left=this.geometryNode.left,t.right=this.geometryNode.right}}getChildren(){var t=[];return this.left&&t.push(this.left),this.right&&t.push(this.right),t}}class PointCloudArena4D extends PointCloudTree{constructor(t){super(),this.root=null,t.root?this.root=t.root:t.addEventListener("hierarchy_loaded",()=>{this.root=t.root}),this.visiblePointsTarget=2e6,this.minimumNodePixelSize=150,this.position.sub(t.offset),this.updateMatrix(),this.numVisiblePoints=this.numVisibleNodes=0,this.boundingBoxNodes=[],this.loadQueue=[],this.visibleNodes=[],this.pcoGeometry=t,this.boundingBox=this.pcoGeometry.boundingBox,this.boundingSphere=this.pcoGeometry.boundingSphere,this.material=new PointCloudMaterial({vertexColors:THREE.VertexColors,size:.05,treeType:Potree.TreeType.KDTREE}),this.material.sizeType=Potree.PointSizeType.ATTENUATED,this.material.size=.05,this.profileRequests=[],this.name=""}getBoundingBoxWorld(){return this.updateMatrixWorld(!0),HelperUtils.computeTransformedBoundingBox(this.boundingBox,this.matrixWorld)}setName(t){this.name!==t&&(this.name=t,this.dispatchEvent({type:"name_changed",name:t,pointcloud:this}))}getName(){return this.name}getLevel(){return this.level}toTreeNode(t,e){var n=new PointCloudArena4DNode,i=new THREE.Points(t.geometry,this.material);return i.frustumCulled=!0,i.onBeforeRender=((e,i,r,o,s,a)=>{s.program&&(e.getContext().useProgram(s.program.program),s.program.getUniforms().map.level&&(i=t.getLevel(),s.uniforms.level.value=i,s.program.getUniforms().map.level.setValue(e.getContext(),i)),this.visibleNodeTextureOffsets&&s.program.getUniforms().map.vnStart&&(i=this.visibleNodeTextureOffsets.get(n),s.uniforms.vnStart.value=i,s.program.getUniforms().map.vnStart.setValue(e.getContext(),i)),s.program.getUniforms().map.pcIndex&&(i=n.pcIndex?n.pcIndex:this.visibleNodes.indexOf(n),s.uniforms.pcIndex.value=i,s.program.getUniforms().map.pcIndex.setValue(e.getContext(),i)))}),n.geometryNode=t,n.sceneNode=i,n.pointcloud=this,n.left=t.left,n.right=t.right,e?(e.sceneNode.add(i),e.left===t?e.left=n:e.right===t&&(e.right=n)):(this.root=n,this.add(i)),t.oneTimeDisposeHandlers.push(function(){e.sceneNode.remove(n.sceneNode),e.left===n?e.left=t:e.right===n&&(e.right=t)}),n}updateMaterial(t,e,n,i){t.fov=Math.PI/180*n.fov,t.screenWidth=i.domElement.clientWidth,t.screenHeight=i.domElement.clientHeight,t.spacing=this.pcoGeometry.spacing,t.near=n.near,t.far=n.far,this.maxLevel>t.levels&&(t.levels=this.maxLevel+2),e=this.boundingBox.getSize(new THREE.Vector3),t.bbSize=[e.x,e.y,e.z]}updateVisibleBounds(){}hideDescendants(t){for(var e=[],n=0;n<t.children.length;n++){var i=t.children[n];i.visible&&e.push(i)}for(;0<e.length;)for((i=e.shift()).visible=!1,i.boundingBoxNode&&(i.boundingBoxNode.visible=!1),n=0;n<i.children.length;n++)(t=i.children[n]).visible&&e.push(t)}updateMatrixWorld(t){!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==t||(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1)}nodesOnRay(t,e){var n=[];e=e.clone();for(var i=0;i<t.length;i++){var r=t[i],o=r.getBoundingSphere(new THREE.Sphere).clone().applyMatrix4(r.sceneNode.matrixWorld);e.intersectsSphere(o)&&n.push(r)}return n}pick(t,e,n,i={}){var r=t.renderer,o=t.pRenderer;performance.mark("pick-start");var s=(t,e)=>void 0!==t?t:e;t=s(i.pickWindowSize,17),s(i.pickOutsideClipRegion,!1);var a=r.getSize(new THREE.Vector3),u=Math.ceil(s(i.width,a.width));a=Math.ceil(s(i.height,a.height));var l=s(i.pointSizeType,this.material.pointSizeType);if(s=s(i.pointSize,this.material.size),0===(n=this.nodesOnRay(this.visibleNodes,n)).length)return null;if(!this.pickState){var d=new THREE.Scene,h=new PointCloudMaterial;h.pointColorType=Potree.PointColorType.POINT_INDEX,this.pickState={renderTarget:new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),material:h,scene:d}}(h=(d=this.pickState).material).pointSizeType=l,h.shape=this.material.shape,h.size=s,h.uniforms.minSize.value=this.material.uniforms.minSize.value,h.uniforms.maxSize.value=this.material.uniforms.maxSize.value,h.classification=this.material.classification,i.pickClipped?(h.clipBoxes=this.material.clipBoxes,h.clipTask=this.material.clipTask===Potree.ClipTask.HIGHLIGHT?Potree.ClipTask.NONE:this.material.clipTask):h.clipBoxes=[],this.updateMaterial(h,n,e,r),d.renderTarget.setSize(u,a),s=new THREE.Vector2(i.x,i.y),(l=r.getContext()).enable(l.SCISSOR_TEST),l.scissor(parseInt(s.x-(t-1)/2),parseInt(s.y-(t-1)/2),parseInt(t),parseInt(t)),r.state.buffers.depth.setTest(h.depthTest),r.state.buffers.depth.setMask(h.depthWrite),r.state.setBlending(THREE.NoBlending),r.clearTarget(d.renderTarget,!0,!0,!0),r.setRenderTarget(d.renderTarget),l.clearColor(0,0,0,0),r.clearTarget(d.renderTarget,!0,!0,!0);var p=this.material;for(this.material=h,o.renderOctree(this,n,e,d.renderTarget),this.material=p,e=parseInt(Math.min(Math.max(0,s.x-(t-1)/2),u)),o=parseInt(Math.min(Math.max(0,s.y-(t-1)/2),a)),u=parseInt(Math.min(e+t,u)-e),a=parseInt(Math.min(o+t,a)-o),u=new Uint8Array(4*u*a),l.readPixels(e,o,t,t,l.RGBA,l.UNSIGNED_BYTE,u),r.setRenderTarget(null),r.resetGLState(),r.setScissorTest(!1),l.disable(l.SCISSOR_TEST),a=new Uint32Array(u.buffer),r=[],e=0;e<t;e++)for(o=0;o<t;o++)if(d=e+o*t,l=Math.pow(e-(t-1)/2,2)+Math.pow(o-(t-1)/2,2),s=u[4*d+3],u[4*d+3]=0,d=a[d],(0!==s||0!==d)&&void 0!==s&&void 0!==d){var c={pIndex:d,pcIndex:s,distanceToCenter:l};i.all?r.push(c):0<r.length?l<r[0].distanceToCenter&&(r[0]=c):r.push(c)}for(c of r){if(t={},!n[c.pcIndex])return null;for(var f in u=(a=n[c.pcIndex]).sceneNode,(a=a.geometryNode.geometry).attributes)l=a.attributes[f],"position"===f&&(e=l.array[3*c.pIndex],o=l.array[3*c.pIndex+1],(e=new THREE.Vector3(e,o,l.array[3*c.pIndex+2])).applyMatrix4(u.matrixWorld),t[f]=e);c.point=t}return performance.mark("pick-end"),performance.measure("pick","pick-start","pick-end"),i.all?r.map(t=>t.point):0===r.length?null:r[0].point}computeVisibilityTextureData(t){Potree.measureTimings&&performance.mark("computeVisibilityTextureData-start");var e=new Uint8Array(3*t.length),n=new Map;(t=t.slice()).sort(function(t,e){var n=t.geometryNode.level,i=e.geometryNode.level;return t=t.geometryNode.number,e=e.geometryNode.number,n!==i?n-i:t<e?-1:t>e?1:0});for(var i=[],r=0;r<t.length;r++)i.push(t[r].geometryNode.number);for(r=0;r<t.length;r++){var o=t[r];n.set(o,r);var s=0,a=0,u=0;o.geometryNode.left&&0<i.indexOf(o.geometryNode.left.number)&&(s+=1,a=i.indexOf(o.geometryNode.left.number)-r),o.geometryNode.right&&0<i.indexOf(o.geometryNode.right.number)&&(s+=2,a=0===a?i.indexOf(o.geometryNode.right.number)-r:a),"X"===o.geometryNode.split?u=1:"Y"===o.geometryNode.split?u=2:"Z"===o.geometryNode.split&&(u=4),e[3*r]=s,e[3*r+1]=a,e[3*r+2]=u}return Potree.measureTimings&&(performance.mark("computeVisibilityTextureData-end"),performance.measure("render.computeVisibilityTextureData","computeVisibilityTextureData-start","computeVisibilityTextureData-end")),{data:e,offsets:n}}get progress(){return this.pcoGeometry.root?0<Potree.numNodesLoading?0:1:0}}class PointCloudOctreeNode extends PointCloudTreeNode{constructor(){super(),this.children={},this.octree=this.sceneNode=null}getNumPoints(){return this.geometryNode.numPoints}isLoaded(){return!0}isTreeNode(){return!0}isGeometryNode(){return!1}getLevel(){return this.geometryNode.level}getBoundingSphere(){return this.geometryNode.boundingSphere}getBoundingBox(){return this.geometryNode.boundingBox}getChildren(){for(var t=[],e=0;8>e;e++)this.children[e]&&t.push(this.children[e]);return t}getPointsInBox(t){if(!this.sceneNode)return null;var e=this.geometryNode.buffer,n=e.offset("position"),i=e.stride,r=new DataView(e.data);t=(new THREE.Matrix4).getInverse(t.matrixWorld),t=(new THREE.Matrix4).multiplyMatrices(t,this.sceneNode.matrixWorld);for(var o=[],s=new THREE.Vector4,a=0;a<e.numElements;a++){var u=r.getFloat32(a*i+n+0,!0),l=r.getFloat32(a*i+n+4,!0),d=r.getFloat32(a*i+n+8,!0);s.set(u,l,d,1),s.applyMatrix4(t),-.5<s.x&&.5>s.x&&-.5<s.y&&.5>s.y&&-.5<s.z&&.5>s.z&&(s.set(u,l,d,1).applyMatrix4(this.sceneNode.matrixWorld),o.push(new THREE.Vector3(s.x,s.y,s.z)))}return o}get name(){return this.geometryNode.name}}class PointCloudOctree extends PointCloudTree{constructor(t,e){super(),this.pointBudget=1/0,this.pcoGeometry=t,this.boundingBox=this.pcoGeometry.boundingBox,this.boundingSphere=this.boundingBox.getBoundingSphere(new THREE.Sphere),this.material=e||new PointCloudMaterial,this.visiblePointsTarget=2e6,this.minimumNodePixelSize=150,this.level=0,this.position.copy(t.offset),this.updateMatrix(),this.showBoundingBox=!1,this.boundingBoxNodes=[],this.loadQueue=[],this.visibleBounds=new THREE.Box3,this.visibleNodes=[],this.visibleGeometry=[],this.generateDEM=!1,this.profileRequests=[],this.name="",this.tempVector3=new THREE.Vector3,e=[this.pcoGeometry.tightBoundingBox,this.getBoundingBoxWorld()].find(t=>void 0!==t),this.updateMatrixWorld(!0);var n=(e=HelperUtils.computeTransformedBoundingBox(e,this.matrixWorld)).max.z;this.material.heightMin=e.min.z,this.material.heightMax=n,this.projection=t.projection,this.root=this.pcoGeometry.root}setName(t){this.name!==t&&(this.name=t,this.dispatchEvent({type:"name_changed",name:t,pointcloud:this}))}getName(){return this.name}toTreeNode(t,e){var n=new PointCloudOctreeNode,i=new THREE.Points(t.geometry,this.material);for(var r in i.name=t.name,i.position.copy(t.boundingBox.min),i.frustumCulled=!0,i.onBeforeRender=((e,i,r,o,s,a)=>{s.program&&(e.getContext().useProgram(s.program.program),s.program.getUniforms().map.level&&(i=t.getLevel(),s.uniforms.level.value=i,s.program.getUniforms().map.level.setValue(e.getContext(),i)),this.visibleNodeTextureOffsets&&s.program.getUniforms().map.vnStart&&(i=this.visibleNodeTextureOffsets.get(n),s.uniforms.vnStart.value=i,s.program.getUniforms().map.vnStart.setValue(e.getContext(),i)),s.program.getUniforms().map.pcIndex&&(i=n.pcIndex?n.pcIndex:this.visibleNodes.indexOf(n),s.uniforms.pcIndex.value=i,s.program.getUniforms().map.pcIndex.setValue(e.getContext(),i)))}),n.geometryNode=t,n.sceneNode=i,n.pointcloud=this,n.children={},t.children)n.children[r]=t.children[r];return e?(r=parseInt(t.name[t.name.length-1]),e.sceneNode.add(i),e.children[r]=n):(this.root=n,this.add(i)),t.oneTimeDisposeHandlers.push(function(){var i=parseInt(t.name[t.name.length-1]);e.sceneNode.remove(n.sceneNode),e.children[i]=t}),n}updateVisibleBounds(){for(var t=[],e=0;e<this.visibleNodes.length;e++){for(var n=this.visibleNodes[e],i=!0,r=0;r<n.children.length;r++){var o=n.children[r];o instanceof PointCloudOctreeNode?i=i&&!o.sceneNode.visible:o instanceof PointCloudOctreeGeometryNode&&(i=!0)}i&&t.push(n)}for(this.visibleBounds.min=new THREE.Vector3(1/0,1/0,1/0),this.visibleBounds.max=new THREE.Vector3(-1/0,-1/0,-1/0),e=0;e<t.length;e++)n=t[e],this.visibleBounds.expandByPoint(n.getBoundingBox().min),this.visibleBounds.expandByPoint(n.getBoundingBox().max)}updateMaterial(t,e,n,i){t.fov=Math.PI/180*n.fov,t.screenWidth=i.domElement.clientWidth,t.screenHeight=i.domElement.clientHeight,t.spacing=this.pcoGeometry.spacing*Math.max(this.scale.x,this.scale.y,this.scale.z),t.near=n.near,t.far=n.far,t.uniforms.octreeSize.value=this.pcoGeometry.boundingBox.getSize(new THREE.Vector3).x}computeVisibilityTextureData(t,e){Potree.measureTimings&&performance.mark("computeVisibilityTextureData-start");var n=new Uint8Array(4*t.length),i=new Map;(t=t.slice()).sort(function(t,e){return t=t.geometryNode.name,e=e.geometryNode.name,t.length!==e.length?t.length-e.length:t<e?-1:t>e?1:0});for(var r=new THREE.Vector3,o=(t,e)=>{r.subVectors(e.center,t.origin),t=r.dot(t.direction);var n=r.dot(r)-t*t;return n>(e=e.radius*e.radius)?null:0>(e=t+Math.sqrt(e-n))?null:e},s=new Map,a=new Map,u=0;u<t.length;u++){var l=t[u];i.set(l,u);for(var d=[],h=0;8>h;h++){var p=l.children[h];p&&p.constructor===PointCloudOctreeNode&&t.includes(p,u)&&d.push(p)}for(n[4*u]=0,n[4*u+1]=0,n[4*u+2]=0,n[4*u+3]=l.getLevel(),h=0;h<d.length;h++){p=d[h];var c=parseInt(p.geometryNode.name.substr(-1));n[4*u]+=Math.pow(2,c),0===h&&(p=t.indexOf(p,u),n[4*u+1]=p-u>>8,n[4*u+2]=(p-u)%256)}if((h=l.getBoundingBox().clone().getBoundingSphere(new THREE.Sphere)).applyMatrix4(l.sceneNode.matrixWorld),h.applyMatrix4(e.matrixWorldInverse),d=o(d=new THREE.Ray(e.position,e.getWorldDirection(this.tempVector3)),h),h=h.center.distanceTo(e.position)+h.radius,null===d&&(d=h),d=Math.max(d,h),s.has(l.getLevel())?(h=s.get(l.getLevel()),h=Math.max(h,d),s.set(l.getLevel(),h)):s.set(l.getLevel(),d),!l.geometryNode.hasChildren){var f={distance:d,i:u};a.set(l,f)}}for([l,f]of a)if(t=l.getLevel(),d=f.distance,u=f.i,!(4>t)){var m,g;for([m,g]of s)d<1.2*g&&(n[4*u+3]=m)}return Potree.measureTimings&&(performance.mark("computeVisibilityTextureData-end"),performance.measure("render.computeVisibilityTextureData","computeVisibilityTextureData-start","computeVisibilityTextureData-end")),{data:n,offsets:i}}nodeIntersectsProfile(t,e){t=t.boundingBox.clone().applyMatrix4(this.matrixWorld).getBoundingSphere(new THREE.Sphere);for(var n=!1,i=0;i<e.points.length-1;i++){var r=new THREE.Vector3(e.points[i+0].x,e.points[i+0].y,t.center.z),o=new THREE.Vector3(e.points[i+1].x,e.points[i+1].y,t.center.z);r=new THREE.Line3(r,o).closestPointToPoint(t.center,!0).distanceTo(t.center),n=n||r<t.radius+e.width}return n}nodesOnRay(t,e){var n=[];e=e.clone();for(var i=0;i<t.length;i++){var r=t[i],o=r.getBoundingSphere(new THREE.Sphere).clone().applyMatrix4(this.matrixWorld);e.intersectsSphere(o)&&n.push(r)}return n}updateMatrixWorld(t){!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==t||(this.parent?this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1)}hideDescendants(t){for(var e=[],n=0;n<t.children.length;n++){var i=t.children[n];i.visible&&e.push(i)}for(;0<e.length;)for((t=e.shift()).visible=!1,n=0;n<t.children.length;n++)(i=t.children[n]).visible&&e.push(i)}moveToOrigin(){this.position.set(0,0,0),this.updateMatrixWorld(!0);var t=HelperUtils.computeTransformedBoundingBox(this.boundingBox,this.matrixWorld);this.position.set(0,0,0).sub(t.getCenter())}moveToGroundPlane(){this.updateMatrixWorld(!0);var t=HelperUtils.computeTransformedBoundingBox(this.boundingBox,this.matrixWorld);this.position.y+=-t.min.y}getBoundingBoxWorld(){return this.updateMatrixWorld(!0),HelperUtils.computeTransformedBoundingBox(this.boundingBox,this.matrixWorld)}getPointsInProfile(t,e,n){if(n)return n=new Potree.ProfileRequest(this,t,e,n),this.profileRequests.push(n),n;n={segments:[],boundingBox:new THREE.Box3,projectedBoundingBox:new THREE.Box2};for(var i=0;i<t.points.length-1;i++){var r=t.points[i],o=t.points[i+1],s=this.getProfile(r,o,t.width,e),a={start:r,end:o,points:s,project:null};n.segments.push(a),n.boundingBox.expandByPoint(s.boundingBox.min),n.boundingBox.expandByPoint(s.boundingBox.max)}for(t=new THREE.Vector3,i=0;i<n.segments.length;i++)e=function(t,e,n,i){var r=new THREE.Vector3(1,0,0);(e=(new THREE.Vector3).subVectors(e,t)).y=0,e.normalize();var o=Math.acos(r.dot(e));return 0<e.z&&(o=-o),function(e){var r=(new THREE.Matrix4).makeTranslation(-t.x,-i.min.y,-t.z),s=(new THREE.Matrix4).makeRotationY(-o),a=(new THREE.Matrix4).makeTranslation(n.x,0,0);return(e=e.clone()).applyMatrix4(r),e.applyMatrix4(s),e.applyMatrix4(a),e}}(r=(a=n.segments[i]).start,o=a.end,t.clone(),n.boundingBox.clone()),a.project=e,t.x+=new THREE.Vector3(r.x,0,r.z).distanceTo(new THREE.Vector3(o.x,0,o.z)),t.y+=o.y-r.y;return n.projectedBoundingBox.min.x=0,n.projectedBoundingBox.min.y=n.boundingBox.min.y,n.projectedBoundingBox.max.x=t.x,n.projectedBoundingBox.max.y=n.boundingBox.max.y,n}getProfile(t,e,n,i,r){t=new Potree.ProfileRequest(t,e,n,i,r),this.profileRequests.push(t)}getVisibleExtent(){return this.visibleBounds.applyMatrix4(this.matrixWorld)}pick(t,e,n,i={}){var r=t.renderer,o=t.pRenderer;performance.mark("pick-start");var s=(t,e)=>void 0!==t?t:e;t=s(i.pickWindowSize,17),s(i.pickOutsideClipRegion,!1);var a=r.getSize(new THREE.Vector3),u=Math.ceil(s(i.width,a.width));a=Math.ceil(s(i.height,a.height));var l=s(i.pointSizeType,this.material.pointSizeType);if(s=s(i.pointSize,this.material.size),0===(n=this.nodesOnRay(this.visibleNodes,n)).length)return null;if(!this.pickState){var d=new THREE.Scene,h=new PointCloudMaterial;h.pointColorType=Potree.PointColorType.POINT_INDEX,this.pickState={renderTarget:new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),material:h,scene:d}}(h=(d=this.pickState).material).pointSizeType=l,h.shape=this.material.shape,h.size=s,h.uniforms.minSize.value=this.material.uniforms.minSize.value,h.uniforms.maxSize.value=this.material.uniforms.maxSize.value,h.classification=this.material.classification,i.pickClipped?(h.clipBoxes=this.material.clipBoxes,h.clipTask=this.material.clipTask===Potree.ClipTask.HIGHLIGHT?Potree.ClipTask.NONE:this.material.clipTask):h.clipBoxes=[],this.updateMaterial(h,n,e,r),d.renderTarget.setSize(u,a),s=new THREE.Vector2(i.x,i.y),(l=r.getContext()).enable(l.SCISSOR_TEST),l.scissor(parseInt(s.x-(t-1)/2),parseInt(s.y-(t-1)/2),parseInt(t),parseInt(t)),r.state.buffers.depth.setTest(h.depthTest),r.state.buffers.depth.setMask(h.depthWrite),r.state.setBlending(THREE.NoBlending),r.setRenderTarget(d.renderTarget),l.clearColor(0,0,0,0),r.clearTarget(d.renderTarget,!0,!0,!0);var p=this.material;for(this.material=h,o.renderOctree(this,n,e,d.renderTarget),this.material=p,e=parseInt(Math.min(Math.max(0,s.x-(t-1)/2),u)),o=parseInt(Math.min(Math.max(0,s.y-(t-1)/2),a)),u=parseInt(Math.min(e+t,u)-e),a=parseInt(Math.min(o+t,a)-o),u=new Uint8Array(4*u*a),l.readPixels(e,o,t,t,l.RGBA,l.UNSIGNED_BYTE,u),r.setRenderTarget(null),r.resetGLState(),r.setScissorTest(!1),l.disable(l.SCISSOR_TEST),a=new Uint32Array(u.buffer),r=[],e=0;e<t;e++)for(o=0;o<t;o++)if(d=e+o*t,l=Math.pow(e-(t-1)/2,2)+Math.pow(o-(t-1)/2,2),s=u[4*d+3],u[4*d+3]=0,d=a[d],(0!==s||0!==d)&&void 0!==s&&void 0!==d){var c={pIndex:d,pcIndex:s,distanceToCenter:l};i.all?r.push(c):0<r.length?l<r[0].distanceToCenter&&(r[0]=c):r.push(c)}for(c of r){if(t={},!n[c.pcIndex])return null;for(var f in u=(a=n[c.pcIndex]).sceneNode,(a=a.geometryNode.geometry).attributes)l=a.attributes[f],"position"===f&&(e=l.array[3*c.pIndex],o=l.array[3*c.pIndex+1],(e=new THREE.Vector3(e,o,l.array[3*c.pIndex+2])).applyMatrix4(u.matrixWorld),t[f]=e);c.point=t}return performance.mark("pick-end"),performance.measure("pick","pick-start","pick-end"),i.all?r.map(t=>t.point):0===r.length?null:r[0].point}*getFittedBoxGen(t){var e=new THREE.Box3,n=(new THREE.Matrix4).getInverse(t.matrixWorld);for(c of this.visibleNodes)if(c.sceneNode){for(var i=c.geometryNode.buffer,r=i.offset("position"),o=i.stride,s=new DataView(i.data),a=(new THREE.Matrix4).multiplyMatrices(n,c.sceneNode.matrixWorld),u=new THREE.Vector4,l=0;l<i.numElements;l++){var d=s.getFloat32(l*o+r+0,!0),h=s.getFloat32(l*o+r+4,!0),p=s.getFloat32(l*o+r+8,!0);u.set(d,h,p,1),u.applyMatrix4(a),-.5<u.x&&.5>u.x&&-.5<u.y&&.5>u.y&&-.5<u.z&&.5>u.z&&e.expandByPoint(u)}yield}var c=e.getCenter().applyMatrix4(t.matrixWorld);(n=new THREE.Object3D).position.copy(c),n.scale.copy(t.scale),n.rotation.copy(t.rotation),t=(new THREE.Vector3).subVectors(e.max,e.min),n.scale.multiply(t),yield n}getFittedBox(t,e=1/0){var n,i=new THREE.Box3,r=(new THREE.Matrix4).getInverse(t.matrixWorld);for(n of this.visibleNodes)if(n.sceneNode&&!(n.getLevel()>e))for(var o=n.geometryNode.buffer,s=o.offset("position"),a=o.stride,u=new DataView(o.data),l=(new THREE.Matrix4).multiplyMatrices(r,n.sceneNode.matrixWorld),d=new THREE.Vector4,h=0;h<o.numElements;h++){var p=u.getFloat32(h*a+s+0,!0),c=u.getFloat32(h*a+s+4,!0),f=u.getFloat32(h*a+s+8,!0);d.set(p,c,f,1),d.applyMatrix4(l),-.5<d.x&&.5>d.x&&-.5<d.y&&.5>d.y&&-.5<d.z&&.5>d.z&&i.expandByPoint(d)}return r=i.getCenter().applyMatrix4(t.matrixWorld),(e=new THREE.Object3D).position.copy(r),e.scale.copy(t.scale),e.rotation.copy(t.rotation),t=(new THREE.Vector3).subVectors(i.max,i.min),e.scale.multiply(t),e}get progress(){return this.visibleNodes.length/this.visibleGeometry.length}find(t){var e,n=null;for(e of t)n="r"===e?this.root:n.children[e];return n}}class PointCloudOctreeGeometry{constructor(){this.octreeDir=this.url=null,this.spacing=0,this.pointAttributes=this.nodes=this.root=this.boundingBox=null,this.hierarchyStepSize=-1,this.loader=null}}class PointCloudOctreeGeometryNode extends PointCloudTreeNode{constructor(t,e,n){super(),this.id=PointCloudOctreeGeometryNode.IDCount++,this.name=t,this.index=parseInt(t.charAt(t.length-1)),this.pcoGeometry=e,this.geometry=null,this.boundingBox=n,this.boundingSphere=n.getBoundingSphere(new THREE.Sphere),this.children={},this.numPoints=0,this.level=null,this.loaded=!1,this.oneTimeDisposeHandlers=[]}isGeometryNode(){return!0}getLevel(){return this.level}isTreeNode(){return!1}isLoaded(){return this.loaded}getBoundingSphere(){return this.boundingSphere}getBoundingBox(){return this.boundingBox}getChildren(){for(var t=[],e=0;8>e;e++)this.children[e]&&t.push(this.children[e]);return t}getURL(){var t="",e=this.pcoGeometry.loader.version;return e.equalOrHigher("1.5")?t=this.pcoGeometry.octreeDir+"/"+this.getHierarchyPath()+"/"+this.name:e.equalOrHigher("1.4")?t=this.pcoGeometry.octreeDir+"/"+this.name:e.upTo("1.3")&&(t=this.pcoGeometry.octreeDir+"/"+this.name),t}getHierarchyPath(){for(var t="r/",e=this.pcoGeometry.hierarchyStepSize,n=this.name.substr(1),i=Math.floor(n.length/e),r=0;r<i;r++)t+=n.substr(r*e,e)+"/";return t.slice(0,-1)}addChild(t){this.children[t.index]=t,t.parent=this}load(){!0===this.loading||!0===this.loaded||Potree.numNodesLoading>=Potree.maxNodesLoading||(this.loading=!0,Potree.numNodesLoading++,this.pcoGeometry.loader.version.equalOrHigher("1.5")&&0==this.level%this.pcoGeometry.hierarchyStepSize&&this.hasChildren?this.loadHierachyThenPoints():this.loadPoints())}loadPoints(){this.pcoGeometry.loader.load(this)}loadHierachyThenPoints(){var t=this;if(0==t.level%t.pcoGeometry.hierarchyStepSize){var e=t.pcoGeometry.octreeDir+"/"+t.getHierarchyPath()+"/"+t.name+".hrc",n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.overrideMimeType("text/plain; charset=x-user-defined"),n.onreadystatechange=function(i){if(4===n.readyState)if(200===n.status||0===n.status){var r=n.response,o=new DataView(r),s=[];i=o.getUint8(0);var a=o.getUint32(1,!0);t.numPoints=a,s.push({children:i,numPoints:a,name:t.name}),i=[];for(var u=5;0<s.length;){var l=s.shift(),d=1;for(a=0;8>a;a++){if(0!=(l.children&d)){var h=l.name+a,p=o.getUint8(u),c=o.getUint32(u+1,!0);s.push({children:p,numPoints:c,name:h}),i.push({children:p,numPoints:c,name:h}),u+=5}d*=2}if(u===r.byteLength)break}for((r={})[t.name]=t,o=t.pcoGeometry,a=0;a<i.length;a++)s=i[a].name,u=i[a].numPoints,h=parseInt(s.charAt(s.length-1)),l=r[l=s.substring(0,s.length-1)],d=s.length-1,h=Potree.POCLoader.createChildAABB(l.boundingBox,h),(h=new PointCloudOctreeGeometryNode(s,o,h)).level=d,h.numPoints=u,h.hasChildren=0<i[a].children,h.spacing=o.spacing/Math.pow(2,d),l.addChild(h),r[s]=h;t.loadPoints()}else console.log("Failed to load file! HTTP status: "+n.status+", file: "+e),Potree.numNodesLoading--},n.send(null)}}getNumPoints(){return this.numPoints}dispose(){if(this.geometry&&null!=this.parent){this.geometry.dispose(),this.geometry=null,this.loaded=!1;for(var t=0;t<this.oneTimeDisposeHandlers.length;t++)(0,this.oneTimeDisposeHandlers[t])();this.oneTimeDisposeHandlers=[]}}}PointCloudOctreeGeometryNode.IDCount=0,Object.assign(PointCloudOctreeGeometryNode.prototype,THREE.EventDispatcher.prototype);class PointCloudArena4DGeometryNode{constructor(){this.pcoGeometry=this.number=this.boundingBox=this.right=this.left=null,this.loaded=!1,this.level=this.numPoints=0,this.children=[],this.oneTimeDisposeHandlers=[]}isGeometryNode(){return!0}isTreeNode(){return!1}isLoaded(){return this.loaded}getBoundingSphere(){return this.boundingSphere}getBoundingBox(){return this.boundingBox}getChildren(){var t=[];return this.left&&t.push(this.left),this.right&&t.push(this.right),t}getLevel(){return this.level}load(){if(!(this.loaded||this.loading||Potree.numNodesLoading>=Potree.maxNodesLoading)){this.loading=!0,Potree.numNodesLoading++;var t=this,e=this.pcoGeometry.url+"?node="+this.number,n=new XMLHttpRequest;n.overrideMimeType("text/plain"),n.open("GET",e,!0),n.responseType="arraybuffer",n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){var e=n.response,i=new DataView(e);e=e.byteLength/17;var r=new ArrayBuffer(28*e);new DataView(r),r=new Float32Array(3*e);for(var o=new Uint8Array(4*e),s=new Float32Array(e),a=new Uint8Array(e),u=new ArrayBuffer(4*e),l=new Uint32Array(u),d=new THREE.Box3,h=0;h<e;h++){var p=i.getFloat32(17*h,!0)+t.boundingBox.min.x,c=i.getFloat32(17*h+4,!0)+t.boundingBox.min.y,f=i.getFloat32(17*h+8,!0)+t.boundingBox.min.z,m=i.getUint8(17*h+12,!0),g=i.getUint8(17*h+13,!0),y=i.getUint8(17*h+14,!0),E=i.getUint8(17*h+15,!0),v=i.getUint8(17*h+16,!0);d.expandByPoint(new THREE.Vector3(p,c,f)),r[3*h]=p,r[3*h+1]=c,r[3*h+2]=f,o[4*h]=m,o[4*h+1]=g,o[4*h+2]=y,o[4*h+3]=255,s[h]=E,a[h]=v,l[h]=h}(i=new THREE.BufferGeometry).addAttribute("position",new THREE.BufferAttribute(r,3)),i.addAttribute("color",new THREE.BufferAttribute(o,4,!0)),i.addAttribute("intensity",new THREE.BufferAttribute(s,1)),i.addAttribute("classification",new THREE.BufferAttribute(a,1)),r=new THREE.BufferAttribute(new Uint8Array(u),4,!0),i.addAttribute("indices",r),t.geometry=i,t.numPoints=e,t.loaded=!0,t.loading=!1,Potree.numNodesLoading--}},n.send(null)}}dispose(){if(this.geometry&&null!=this.parent){this.geometry.dispose(),this.geometry=null,this.loaded=!1;for(var t=0;t<this.oneTimeDisposeHandlers.length;t++)(0,this.oneTimeDisposeHandlers[t])();this.oneTimeDisposeHandlers=[]}}getNumPoints(){return this.numPoints}}class PointCloudArena4DGeometry extends THREE.EventDispatcher{constructor(){super(),this.version=this.numPoints=0,this.boundingBox=null,this.numNodes=0,this.root=this.url=this.provider=this.name=null,this.levels=0,this._spacing=null,this.pointAttributes=new Potree.PointAttributes(["POSITION_CARTESIAN","COLOR_PACKED"])}static load(t,e){var n=new XMLHttpRequest;n.overrideMimeType("text/plain"),n.open("GET",t+"?info",!0),n.onreadystatechange=function(){try{if(4===n.readyState&&200===n.status){var i=JSON.parse(n.responseText),r=new PointCloudArena4DGeometry;r.url=t,r.name=i.Name,r.provider=i.Provider,r.numNodes=i.Nodes,r.numPoints=i.Points,r.version=i.Version,r.boundingBox=new THREE.Box3((new THREE.Vector3).fromArray(i.BoundingBox.slice(0,3)),(new THREE.Vector3).fromArray(i.BoundingBox.slice(3,6))),i.Spacing&&(r.spacing=i.Spacing);var o=r.boundingBox.min.clone().multiplyScalar(-1);r.boundingBox.min.add(o),r.boundingBox.max.add(o),r.offset=o;var s=r.boundingBox.getCenter(),a=r.boundingBox.getSize(new THREE.Vector3).length()/2;r.boundingSphere=new THREE.Sphere(s,a),r.loadHierarchy(),e(r)}else 4===n.readyState&&e(null)}catch(t){console.error(t.message),e(null)}},n.send(null)}loadHierarchy(){var t=this.url+"?tree",e=new XMLHttpRequest;e.overrideMimeType("text/plain"),e.open("GET",t,!0),e.responseType="arraybuffer",e.onreadystatechange=(()=>{if(4===e.readyState&&200===e.status){var t=e.response,n=t.byteLength/3;t=new DataView(t);for(var i=[],r=null,o=0,s=0;s<n;s++){var a=t.getUint8(3*s,!0),u=0<(1&a),l=0<(2&a),d=null;if(0<(4&a)?d="X":0<(8&a)&&(d="Y"),0<(16&a)&&(d="Z"),(a=new PointCloudArena4DGeometryNode).hasLeft=u,a.hasRight=l,a.split=d,a.isLeaf=!u&&!l,a.number=s,a.left=null,a.right=null,a.pcoGeometry=this,a.level=i.length,o=Math.max(o,a.level),0<i.length?(u=i[i.length-1],a.boundingBox=u.boundingBox.clone(),l=u.boundingBox.getSize(new THREE.Vector3),u.hasLeft&&!u.left?(u.left=a,u.children.push(a),"X"===u.split?a.boundingBox.max.x=a.boundingBox.min.x+l.x/2:"Y"===u.split?a.boundingBox.max.y=a.boundingBox.min.y+l.y/2:"Z"===u.split&&(a.boundingBox.max.z=a.boundingBox.min.z+l.z/2),u=a.boundingBox.getCenter(),l=a.boundingBox.getSize(new THREE.Vector3).length()/2):(u.right=a,u.children.push(a),"X"===u.split?a.boundingBox.min.x+=l.x/2:"Y"===u.split?a.boundingBox.min.y+=l.y/2:"Z"===u.split&&(a.boundingBox.min.z+=l.z/2),u=a.boundingBox.getCenter(),l=a.boundingBox.getSize(new THREE.Vector3).length()/2),a.boundingSphere=new THREE.Sphere(u,l)):((r=a).boundingBox=this.boundingBox.clone(),u=r.boundingBox.getCenter(),l=r.boundingBox.getSize(new THREE.Vector3).length()/2,r.boundingSphere=new THREE.Sphere(u,l)),u=a.boundingBox.getSize(new THREE.Vector3),a.spacing=(u.x+u.y+u.z)/3/75,a.estimatedSpacing=a.spacing,i.push(a),a.isLeaf)for(a=!1;!a&&0<i.length;)i.pop(),a=i[i.length-1],a=0<i.length&&a.hasRight&&null==a.right}this.root=r,this.levels=o,this.dispatchEvent({type:"hierarchy_loaded"})}}),e.send(null)}get spacing(){return this._spacing?this._spacing:this.root?this.root.spacing:void 0}set spacing(t){this._spacing=t}}function PointCloudGreyhoundGeometry(){this.spacing=0,this.nodes=this.root=this.boundingBox=null,this.pointAttributes={},this.hierarchyStepSize=-1,this.serverURL=this.boundingSphere=this.projection=this.offset=this.baseDepth=this.schema=this.loader=null,this.normalize={color:!1,intensity:!1}}function PointCloudGreyhoundGeometryNode(t,e,n,i,r){this.id=PointCloudGreyhoundGeometryNode.IDCount++,this.name=t,this.index=parseInt(t.charAt(t.length-1)),this.pcoGeometry=e,this.geometry=null,this.boundingBox=n,this.boundingSphere=n.getBoundingSphere(new THREE.Sphere),this.scale=i,this.offset=r,this.children={},this.numPoints=0,this.level=null,this.loaded=!1,this.oneTimeDisposeHandlers=[],this.baseLoaded=!1,(t=this.boundingBox.clone()).min.sub(this.pcoGeometry.boundingBox.getCenter()),t.max.sub(this.pcoGeometry.boundingBox.getCenter()),this.scale&&(t.min.multiplyScalar(1/this.scale),t.max.multiplyScalar(1/this.scale)),this.greyhoundBounds=t,this.greyhoundOffset=this.pcoGeometry.offset.clone().add(this.pcoGeometry.boundingBox.getSize(new THREE.Vector3).multiplyScalar(.5))}PointCloudGreyhoundGeometryNode.IDCount=0,PointCloudGreyhoundGeometryNode.prototype=Object.create(PointCloudTreeNode.prototype),PointCloudGreyhoundGeometryNode.prototype.isGeometryNode=function(){return!0},PointCloudGreyhoundGeometryNode.prototype.isTreeNode=function(){return!1},PointCloudGreyhoundGeometryNode.prototype.isLoaded=function(){return this.loaded},PointCloudGreyhoundGeometryNode.prototype.getBoundingSphere=function(){return this.boundingSphere},PointCloudGreyhoundGeometryNode.prototype.getBoundingBox=function(){return this.boundingBox},PointCloudGreyhoundGeometryNode.prototype.getLevel=function(){return this.level},PointCloudGreyhoundGeometryNode.prototype.getChildren=function(){for(var t=[],e=0;8>e;++e)this.children[e]&&t.push(this.children[e]);return t},PointCloudGreyhoundGeometryNode.prototype.getURL=function(){var t=this.greyhoundBounds;if(t=this.pcoGeometry.serverURL+"read?depthBegin="+(this.baseLoaded?this.level+this.pcoGeometry.baseDepth:0)+"&depthEnd="+(this.level+this.pcoGeometry.baseDepth+1)+"&bounds=["+t.min.x+","+t.min.y+","+t.min.z+","+t.max.x+","+t.max.y+","+t.max.z+"]&schema="+JSON.stringify(this.pcoGeometry.schema)+"&compress=true",this.scale&&(t+="&scale="+this.scale),this.greyhoundOffset){var e=this.greyhoundOffset;t+="&offset=["+e.x+","+e.y+","+e.z+"]"}return this.baseLoaded||(this.baseLoaded=!0),t},PointCloudGreyhoundGeometryNode.prototype.addChild=function(t){this.children[t.index]=t,t.parent=this},PointCloudGreyhoundGeometryNode.prototype.load=function(){!0===this.loading||!0===this.loaded||Potree.numNodesLoading>=Potree.maxNodesLoading||(this.loading=!0,Potree.numNodesLoading++,0==this.level%this.pcoGeometry.hierarchyStepSize&&this.hasChildren?this.loadHierarchyThenPoints():this.loadPoints())},PointCloudGreyhoundGeometryNode.prototype.loadPoints=function(){this.pcoGeometry.loader.load(this)},PointCloudGreyhoundGeometryNode.prototype.loadHierarchyThenPoints=function(){var t=[0,2,1,3,4,6,5,7],e=function(n,i,r){var o,s;Object.keys(n).forEach(function(a){if("n"!==a){switch(a){case"swd":o=n.swd,s=i+t[0];break;case"nwd":o=n.nwd,s=i+t[1];break;case"swu":o=n.swu,s=i+t[2];break;case"nwu":o=n.nwu,s=i+t[3];break;case"sed":o=n.sed,s=i+t[4];break;case"ned":o=n.ned,s=i+t[5];break;case"seu":o=n.seu,s=i+t[6];break;case"neu":o=n.neu,s=i+t[7]}r.push({children:function(e){var n=0;return Object.keys(e).forEach(function(e){"swd"===e?n+=1<<t[0]:"nwd"===e?n+=1<<t[1]:"swu"===e?n+=1<<t[2]:"nwu"===e?n+=1<<t[3]:"sed"===e?n+=1<<t[4]:"ned"===e?n+=1<<t[5]:"seu"===e?n+=1<<t[6]:"neu"===e&&(n+=1<<t[7])}),n}(o),numPoints:o.n,name:s}),e(o,s,r)}})};if(0==this.level%this.pcoGeometry.hierarchyStepSize){var n=this.level+this.pcoGeometry.baseDepth,i=this.greyhoundBounds,r=this.pcoGeometry.serverURL+"hierarchy?bounds=["+i.min.x+","+i.min.y+","+i.min.z+","+i.max.x+","+i.max.y+","+i.max.z+"]&depthBegin="+n+"&depthEnd="+(n+this.pcoGeometry.hierarchyStepSize+2);this.scale&&(r+="&scale="+this.scale),this.greyhoundOffset&&(n=this.greyhoundOffset,r+="&offset=["+n.x+","+n.y+","+n.z+"]");var o=new XMLHttpRequest;o.overrideMimeType("text/plain"),o.open("GET",r,!0);var s=this;o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status){var t=JSON.parse(o.responseText)||{},n=[];s.numPoints=t.n,e(t,s.name,n),(t={})[s.name]=s;for(var i=s.pcoGeometry,a=0;a<n.length;a++){var u=n[a].name,l=n[a].numPoints,d=parseInt(u.charAt(u.length-1)),h=u.substring(0,u.length-1);h=t[h];var p=u.length-1;(d=new PointCloudGreyhoundGeometryNode(u,i,d=Potree.GreyhoundLoader.createChildAABB(h.boundingBox,d),s.scale,s.offset)).level=p,d.numPoints=l,d.hasChildren=0<n[a].children,d.spacing=i.spacing/Math.pow(2,p),h.addChild(d),t[u]=d}s.loadPoints()}else console.log("Failed to load file! HTTP status:",o.status,"file:",r)},o.send(null)}},PointCloudGreyhoundGeometryNode.prototype.getNumPoints=function(){return this.numPoints},PointCloudGreyhoundGeometryNode.prototype.dispose=function(){if(this.geometry&&null!=this.parent){this.geometry.dispose(),this.geometry=null,this.loaded=!1;for(var t=0;t<this.oneTimeDisposeHandlers.length;t++)(0,this.oneTimeDisposeHandlers[t])();this.oneTimeDisposeHandlers=[]}},Object.assign(PointCloudGreyhoundGeometryNode.prototype,THREE.EventDispatcher.prototype);class PointCloudMaterial extends THREE.RawShaderMaterial{constructor(t={}){super(),this.visibleNodesTexture=HelperUtils.generateDataTexture(2048,1,new THREE.Color(16777215)),this.visibleNodesTexture.minFilter=THREE.NearestFilter,this.visibleNodesTexture.magFilter=THREE.NearestFilter;var e=function(t,e){return void 0!==t?t:e},n=e(t.size,1),i=e(t.minSize,2),r=e(t.maxSize,50);t=e(t.treeType,Potree.TreeType.OCTREE),this._pointSizeType=Potree.PointSizeType.FIXED,this._shape=Potree.PointShape.SQUARE,this._pointColorType=Potree.PointColorType.RGB,this._weighted=this._useClipBox=!1,this._gradient=PotreeGradients.SPECTRAL,this._treeType=t,this._snapEnabled=this._useEDL=!1,this._numSnapshots=0,this._defaultElevationRangeChanged=this._defaultIntensityRangeChanged=!1,this.clipBoxes=[],this.clipPolygons=[],this.gradientTexture=PointCloudMaterial.generateGradientTexture(this._gradient),this.fog=this.lights=!1,this.defines=new Map,this.attributes={position:{type:"fv",value:[]},color:{type:"fv",value:[]},normal:{type:"fv",value:[]},intensity:{type:"f",value:[]},classification:{type:"f",value:[]},returnNumber:{type:"f",value:[]},numberOfReturns:{type:"f",value:[]},pointSourceID:{type:"f",value:[]},indices:{type:"fv",value:[]}},this.uniforms={level:{type:"f",value:0},vnStart:{type:"f",value:0},spacing:{type:"f",value:1},blendHardness:{type:"f",value:2},blendDepthSupplement:{type:"f",value:0},fov:{type:"f",value:1},screenWidth:{type:"f",value:1},screenHeight:{type:"f",value:1},near:{type:"f",value:.1},far:{type:"f",value:1},uColor:{type:"c",value:new THREE.Color(16777215)},uOpacity:{type:"f",value:1},size:{type:"f",value:n},minSize:{type:"f",value:i},maxSize:{type:"f",value:r},octreeSize:{type:"f",value:0},bbSize:{type:"fv",value:[0,0,0]},elevationRange:{type:"2fv",value:[0,0]},clipBoxCount:{type:"f",value:0},clipPolygonCount:{type:"i",value:0},clipBoxes:{type:"Matrix4fv",value:[]},clipPolygons:{type:"3fv",value:[]},clipPolygonVCount:{type:"iv",value:[]},clipPolygonVP:{type:"Matrix4fv",value:[]},visibleNodes:{type:"t",value:this.visibleNodesTexture},pcIndex:{type:"f",value:0},gradient:{type:"t",value:this.gradientTexture},classificationLUT:{type:"t",value:this.classificationTexture},uHQDepthMap:{type:"t",value:null},toModel:{type:"Matrix4f",value:[]},diffuse:{type:"fv",value:[1,1,1]},transition:{type:"f",value:.5},intensityRange:{type:"fv",value:[0,65e3]},intensityGamma:{type:"f",value:1},intensityContrast:{type:"f",value:0},intensityBrightness:{type:"f",value:0},rgbGamma:{type:"f",value:1},rgbContrast:{type:"f",value:0},rgbBrightness:{type:"f",value:0},wRGB:{type:"f",value:1},wIntensity:{type:"f",value:0},wElevation:{type:"f",value:0},wClassification:{type:"f",value:0},wReturnNumber:{type:"f",value:0},wSourceID:{type:"f",value:0},useOrthographicCamera:{type:"b",value:!1},clipTask:{type:"i",value:1},clipMethod:{type:"i",value:1},uSnapshot:{type:"tv",value:[]},uSnapshotDepth:{type:"tv",value:[]},uSnapView:{type:"Matrix4fv",value:[]},uSnapProj:{type:"Matrix4fv",value:[]},uSnapProjInv:{type:"Matrix4fv",value:[]},uSnapViewInv:{type:"Matrix4fv",value:[]},uShadowColor:{type:"3fv",value:[0,0,0]}},this.classification=Potree.Classification.DEFAULT,this.defaultAttributeValues.normal=[0,0,0],this.defaultAttributeValues.classification=[0,0,0],this.defaultAttributeValues.indices=[0,0,0,0],this.vertexColors=THREE.VertexColors,n=this.getDefines(),this.vertexShader=n+PotreeShaders["pointcloud.vs"],this.fragmentShader=n+PotreeShaders["pointcloud.fs"]}setDefine(t,e){null!=e?this.defines.get(t)!==e&&(this.defines.set(t,e),this.updateShaderSource()):this.removeDefine(t)}removeDefine(t){this.defines.delete(t)}updateShaderSource(){var t=this.getDefines();this.vertexShader=t+PotreeShaders["pointcloud.vs"],this.fragmentShader=t+PotreeShaders["pointcloud.fs"],this.depthFunc=THREE.LessEqualDepth,this.needsUpdate=this.depthWrite=this.depthTest=!0}onBeforeCompile(t,e){e.capabilities.logarithmicDepthBuffer&&(t.fragmentShader="#define USE_LOGDEPTHBUF\n#define USE_LOGDEPTHBUF_EXT\n#define EPSILON 1e-6\n"+t.fragmentShader,t.vertexShader="#define USE_LOGDEPTHBUF\n#define USE_LOGDEPTHBUF_EXT\n#define EPSILON 1e-6\n"+t.vertexShader)}getDefines(){var t,e=[];for([,t]of(this.pointSizeType===Potree.PointSizeType.FIXED?e.push("#define fixed_point_size"):this.pointSizeType===Potree.PointSizeType.ATTENUATED?e.push("#define attenuated_point_size"):this.pointSizeType===Potree.PointSizeType.ADAPTIVE&&e.push("#define adaptive_point_size"),this.shape===Potree.PointShape.SQUARE?e.push("#define square_point_shape"):this.shape===Potree.PointShape.CIRCLE?e.push("#define circle_point_shape"):this.shape===Potree.PointShape.PARABOLOID&&e.push("#define paraboloid_point_shape"),this._useEDL&&e.push("#define use_edl"),this._snapEnabled&&e.push("#define snap_enabled"),this._pointColorType===Potree.PointColorType.RGB?e.push("#define color_type_rgb"):this._pointColorType===Potree.PointColorType.COLOR?e.push("#define color_type_color"):this._pointColorType===Potree.PointColorType.DEPTH?e.push("#define color_type_depth"):this._pointColorType===Potree.PointColorType.HEIGHT?e.push("#define color_type_height"):this._pointColorType===Potree.PointColorType.INTENSITY?e.push("#define color_type_intensity"):this._pointColorType===Potree.PointColorType.INTENSITY_GRADIENT?e.push("#define color_type_intensity_gradient"):this._pointColorType===Potree.PointColorType.LOD?e.push("#define color_type_lod"):this._pointColorType===Potree.PointColorType.POINT_INDEX?e.push("#define color_type_point_index"):this._pointColorType===Potree.PointColorType.CLASSIFICATION?e.push("#define color_type_classification"):this._pointColorType===Potree.PointColorType.RETURN_NUMBER?e.push("#define color_type_return_number"):this._pointColorType===Potree.PointColorType.SOURCE?e.push("#define color_type_source"):this._pointColorType===Potree.PointColorType.NORMAL?e.push("#define color_type_normal"):this._pointColorType===Potree.PointColorType.PHONG?e.push("#define color_type_phong"):this._pointColorType===Potree.PointColorType.RGB_HEIGHT?e.push("#define color_type_rgb_height"):this._pointColorType===Potree.PointColorType.COMPOSITE&&e.push("#define color_type_composite"),this._treeType===Potree.TreeType.OCTREE?e.push("#define tree_type_octree"):this._treeType===Potree.TreeType.KDTREE&&e.push("#define tree_type_kdtree"),this.weighted&&e.push("#define weighted_splats"),this.defines))e.push(t);return e.join("\n")}setClipBoxes(t){if(t){var e=this.clipBoxes.length!==t.length&&(0===t.length||0===this.clipBoxes.length);for(this.uniforms.clipBoxCount.value=this.clipBoxes.length,this.clipBoxes=t,e&&this.updateShaderSource(),this.uniforms.clipBoxes.value=new Float32Array(16*this.clipBoxes.length),e=0;e<this.clipBoxes.length;e++)this.uniforms.clipBoxes.value.set(t[e].inverse.elements,16*e);for(e=0;e<this.uniforms.clipBoxes.value.length;e++)Number.isNaN(this.uniforms.clipBoxes.value[e])&&(this.uniforms.clipBoxes.value[e]=1/0)}}setClipPolygons(t,e){t&&(this.clipPolygons=t,this.clipPolygons.length!==t.length&&this.updateShaderSource())}get gradient(){return this._gradient}set gradient(t){this._gradient!==t&&(this._gradient=t,this.gradientTexture=PointCloudMaterial.generateGradientTexture(this._gradient),this.uniforms.gradient.value=this.gradientTexture)}get useOrthographicCamera(){return this.uniforms.useOrthographicCamera.value}set useOrthographicCamera(t){this.uniforms.useOrthographicCamera.value!==t&&(this.uniforms.useOrthographicCamera.value=t)}get classification(){return this._classification}set classification(t){var e,n={};for(e of Object.keys(t))n[e]=t[e].clone();if(void 0===this._classification)t=!1;else for(e of(t=Object.keys(n).length===Object.keys(this._classification).length,Object.keys(n)))t=(t=t&&void 0!==this._classification[e])&&n[e].equals(this._classification[e]);t||(this._classification=n,this.recomputeClassification())}recomputeClassification(){this.classificationTexture=PointCloudMaterial.generateClassificationTexture(this._classification),this.uniforms.classificationLUT.value=this.classificationTexture,this.dispatchEvent({type:"material_property_changed",target:this})}get numSnapshots(){return this._numSnapshots}set numSnapshots(t){this._numSnapshots=t}get snapEnabled(){return this._snapEnabled}set snapEnabled(t){this._snapEnabled!==t&&(this._snapEnabled=t,this.updateShaderSource())}get spacing(){return this.uniforms.spacing.value}set spacing(t){this.uniforms.spacing.value!==t&&(this.uniforms.spacing.value=t)}get useClipBox(){return this._useClipBox}set useClipBox(t){this._useClipBox!==t&&(this._useClipBox=t,this.updateShaderSource())}get clipTask(){return this.uniforms.clipTask.value}set clipTask(t){this.uniforms.clipTask.value=t}get clipMethod(){return this.uniforms.clipMethod.value}set clipMethod(t){this.uniforms.clipMethod.value=t}get weighted(){return this._weighted}set weighted(t){this._weighted!==t&&(this._weighted=t,this.updateShaderSource())}get fov(){return this.uniforms.fov.value}set fov(t){this.uniforms.fov.value!==t&&(this.uniforms.fov.value=t,this.updateShaderSource())}get screenWidth(){return this.uniforms.screenWidth.value}set screenWidth(t){this.uniforms.screenWidth.value!==t&&(this.uniforms.screenWidth.value=t,this.updateShaderSource())}get screenHeight(){return this.uniforms.screenHeight.value}set screenHeight(t){this.uniforms.screenHeight.value!==t&&(this.uniforms.screenHeight.value=t,this.updateShaderSource())}get near(){return this.uniforms.near.value}set near(t){this.uniforms.near.value!==t&&(this.uniforms.near.value=t)}get far(){return this.uniforms.far.value}set far(t){this.uniforms.far.value!==t&&(this.uniforms.far.value=t)}get opacity(){return this.uniforms.uOpacity.value}set opacity(t){this.uniforms&&this.uniforms.uOpacity&&this.uniforms.uOpacity.value!==t&&(this.uniforms.uOpacity.value=t,this.updateShaderSource(),this.dispatchEvent({type:"opacity_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}get pointColorType(){return this._pointColorType}set pointColorType(t){this._pointColorType!==t&&(this._pointColorType=t,this.updateShaderSource(),this.dispatchEvent({type:"point_color_type_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}get pointSizeType(){return this._pointSizeType}set pointSizeType(t){this._pointSizeType!==t&&(this._pointSizeType=t,this.updateShaderSource(),this.dispatchEvent({type:"point_size_type_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}get useEDL(){return this._useEDL}set useEDL(t){this._useEDL!==t&&(this._useEDL=t,this.updateShaderSource())}get color(){return this.uniforms.uColor.value}set color(t){this.uniforms.uColor.value.equals(t)||(this.uniforms.uColor.value.copy(t),this.dispatchEvent({type:"color_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}get shape(){return this._shape}set shape(t){this._shape!==t&&(this._shape=t,this.updateShaderSource(),this.dispatchEvent({type:"point_shape_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}get treeType(){return this._treeType}set treeType(t){this._treeType!==t&&(this._treeType=t,this.updateShaderSource())}get bbSize(){return this.uniforms.bbSize.value}set bbSize(t){this.uniforms.bbSize.value=t}get size(){return this.uniforms.size.value}set size(t){this.uniforms.size.value!==t&&(this.uniforms.size.value=t,this.dispatchEvent({type:"point_size_changed",target:this}),this.dispatchEvent({type:"material_property_changed",target:this}))}get elevationRange(){return this.uniforms.elevationRange.value}set elevationRange(t){this.uniforms.elevationRange.value[0]===t[0]&&this.uniforms.elevationRange.value[1]===t[1]||(this.uniforms.elevationRange.value=t,this._defaultElevationRangeChanged=!0,this.dispatchEvent({type:"material_property_changed",target:this}))}get heightMin(){return this.uniforms.elevationRange.value[0]}set heightMin(t){this.elevationRange=[t,this.elevationRange[1]]}get heightMax(){return this.uniforms.elevationRange.value[1]}set heightMax(t){this.elevationRange=[this.elevationRange[0],t]}get transition(){return this.uniforms.transition.value}set transition(t){this.uniforms.transition.value=t}get intensityRange(){return this.uniforms.intensityRange.value}set intensityRange(t){t instanceof Array&&2===t.length&&(t[0]!==this.uniforms.intensityRange.value[0]||t[1]!==this.uniforms.intensityRange.value[1])&&(this.uniforms.intensityRange.value=t,this._defaultIntensityRangeChanged=!0,this.dispatchEvent({type:"material_property_changed",target:this}))}get intensityGamma(){return this.uniforms.intensityGamma.value}set intensityGamma(t){this.uniforms.intensityGamma.value!==t&&(this.uniforms.intensityGamma.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get intensityContrast(){return this.uniforms.intensityContrast.value}set intensityContrast(t){this.uniforms.intensityContrast.value!==t&&(this.uniforms.intensityContrast.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get intensityBrightness(){return this.uniforms.intensityBrightness.value}set intensityBrightness(t){this.uniforms.intensityBrightness.value!==t&&(this.uniforms.intensityBrightness.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get rgbGamma(){return this.uniforms.rgbGamma.value}set rgbGamma(t){this.uniforms.rgbGamma.value!==t&&(this.uniforms.rgbGamma.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get rgbContrast(){return this.uniforms.rgbContrast.value}set rgbContrast(t){this.uniforms.rgbContrast.value!==t&&(this.uniforms.rgbContrast.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get rgbBrightness(){return this.uniforms.rgbBrightness.value}set rgbBrightness(t){this.uniforms.rgbBrightness.value!==t&&(this.uniforms.rgbBrightness.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get weightRGB(){return this.uniforms.wRGB.value}set weightRGB(t){this.uniforms.wRGB.value!==t&&(this.uniforms.wRGB.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get weightIntensity(){return this.uniforms.wIntensity.value}set weightIntensity(t){this.uniforms.wIntensity.value!==t&&(this.uniforms.wIntensity.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get weightElevation(){return this.uniforms.wElevation.value}set weightElevation(t){this.uniforms.wElevation.value!==t&&(this.uniforms.wElevation.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get weightClassification(){return this.uniforms.wClassification.value}set weightClassification(t){this.uniforms.wClassification.value!==t&&(this.uniforms.wClassification.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get weightReturnNumber(){return this.uniforms.wReturnNumber.value}set weightReturnNumber(t){this.uniforms.wReturnNumber.value!==t&&(this.uniforms.wReturnNumber.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}get weightSourceID(){return this.uniforms.wSourceID.value}set weightSourceID(t){this.uniforms.wSourceID.value!==t&&(this.uniforms.wSourceID.value=t,this.dispatchEvent({type:"material_property_changed",target:this}))}static generateGradientTexture(t){var e=document.createElement("canvas");e.width=64,e.height=64;var n=e.getContext("2d");n.rect(0,0,64,64);for(var i=n.createLinearGradient(0,0,64,64),r=0;r<t.length;r++){var o=t[r];i.addColorStop(o[0],"#"+o[1].getHexString())}return n.fillStyle=i,n.fill(),(t=new THREE.CanvasTexture(e)).needsUpdate=!0,t.minFilter=THREE.LinearFilter,t}static generateClassificationTexture(t){for(var e=new Uint8Array(262144),n=0;256>n;n++)for(var i=0;256>i;i++){var r=n+256*i,o=t[n]?t[n]:t[n%32]?t[n%32]:t.DEFAULT;e[4*r]=255*o.x,e[4*r+1]=255*o.y,e[4*r+2]=255*o.z,e[4*r+3]=255*o.w}return(t=new THREE.DataTexture(e,256,256,THREE.RGBAFormat)).magFilter=THREE.NearestFilter,t.needsUpdate=!0,t}disableEvents(){void 0===this._hiddenListeners&&(this._hiddenListeners=this._listeners,this._listeners={})}enableEvents(){this._listeners=this._hiddenListeners,this._hiddenListeners=void 0}copyFrom(t){for(var e of this.uniforms)this.uniforms[e].value=t.uniforms[e].value}}var pointFormatReaders={0:function(t){return{position:[t.getInt32(0,!0),t.getInt32(4,!0),t.getInt32(8,!0)],intensity:t.getUint16(12,!0),classification:t.getUint8(16,!0)}},1:function(t){return{position:[t.getInt32(0,!0),t.getInt32(4,!0),t.getInt32(8,!0)],intensity:t.getUint16(12,!0),classification:t.getUint8(16,!0)}},2:function(t){return{position:[t.getInt32(0,!0),t.getInt32(4,!0),t.getInt32(8,!0)],intensity:t.getUint16(12,!0),classification:t.getUint8(16,!0),color:[t.getUint16(20,!0),t.getUint16(22,!0),t.getUint16(24,!0)]}},3:function(t){return{position:[t.getInt32(0,!0),t.getInt32(4,!0),t.getInt32(8,!0)],intensity:t.getUint16(12,!0),classification:t.getUint8(16,!0),color:[t.getUint16(28,!0),t.getUint16(30,!0),t.getUint16(32,!0)]}}};function readAs(t,e,n,i){if(i=void 0===i||0===i?1:i,e=new e(t=t.slice(n,n+e.BYTES_PER_ELEMENT*i)),void 0===i||1===i)return e[0];for(t=[],n=0;n<i;n++)t.push(e[n]);return t}function parseLASHeader(t){var e={};e.pointsOffset=readAs(t,Uint32Array,96),e.pointsFormatId=readAs(t,Uint8Array,104),e.pointsStructSize=readAs(t,Uint16Array,105),e.pointsCount=readAs(t,Uint32Array,107);var n=131;return e.scale=readAs(t,Float64Array,n,3),n+=24,e.offset=readAs(t,Float64Array,n,3),t=readAs(t,Float64Array,n+24,6),e.maxs=[t[0],t[2],t[4]],e.mins=[t[1],t[3],t[5]],e}var LASLoader=function(t){this.arraybuffer=t};LASLoader.prototype.open=function(){return this.readOffset=0,new Promise(function(t,e){setTimeout(t,0)})},LASLoader.prototype.getHeader=function(){var t=this;return new Promise(function(e,n){setTimeout(function(){t.header=parseLASHeader(t.arraybuffer),e(t.header)},0)})},LASLoader.prototype.readData=function(t,e,n){var i=this;return new Promise(function(e,r){setTimeout(function(){if(!i.header)return r(Error("Cannot start reading data till a header request is issued"));if(1>=n){t=Math.min(t,i.header.pointsCount-i.readOffset);var o=i.header.pointsOffset+i.readOffset*i.header.pointsStructSize;e({buffer:i.arraybuffer.slice(o,o+t*i.header.pointsStructSize),count:t,hasMoreData:i.readOffset+t<i.header.pointsCount}),i.readOffset+=t}else{for(var s=Math.min(t*n,i.header.pointsCount-i.readOffset),a=0,u=new Uint8Array(Math.ceil(s/n)*i.header.pointsStructSize),l=0;l<s;l++)0==l%n&&(o=i.header.pointsOffset+i.readOffset*i.header.pointsStructSize,o=new Uint8Array(i.arraybuffer,o,i.header.pointsStructSize),u.set(o,a*i.header.pointsStructSize),a++),i.readOffset++;e({buffer:u.buffer,count:a,hasMoreData:i.readOffset<i.header.pointsCount})}},0)})},LASLoader.prototype.close=function(){var t=this;return new Promise(function(e,n){t.arraybuffer=null,setTimeout(e,0)})};var LAZLoader=function(t){var e=this;this.arraybuffer=t,this.nextCB=null,this.dorr=function(t,n){e.nextCB=n,Potree.workerPool.runTask(WorkerManager.LAS_LAZ,function(t){null!==e.nextCB&&(e.nextCB(t.data),e.nextCB=null)},t)}};LAZLoader.prototype.open=function(){var t=this;return new Promise(function(e,n){t.dorr({type:"open",arraybuffer:t.arraybuffer},function(t){if(1!==t.status)return n(Error("Failed to open file"));e(!0)})})},LAZLoader.prototype.getHeader=function(){var t=this;return new Promise(function(e,n){t.dorr({type:"header"},function(t){if(1!==t.status)return n(Error("Failed to get header"));e(t.header)})})},LAZLoader.prototype.readData=function(t,e,n){var i=this;return new Promise(function(r,o){i.dorr({type:"read",count:t,offset:e,skip:n},function(t){if(1!==t.status)return o(Error("Failed to read data"));r({buffer:t.buffer,count:t.count,hasMoreData:t.hasMoreData})})})},LAZLoader.prototype.close=function(){var t=this;return new Promise(function(e,n){t.dorr({type:"close"},function(t){if(1!==t.status)return n(Error("Failed to close file"));e(!0)})})};var LASFile=function(t){if(this.arraybuffer=t,this.determineVersion(),12<this.version)throw Error("Only file versions <= 1.2 are supported at this time");if(this.determineFormat(),void 0===pointFormatReaders[this.formatId])throw Error("The point format ID is not supported");this.loader=this.isCompressed?new LAZLoader(this.arraybuffer):new LASLoader(this.arraybuffer)};LASFile.prototype.determineFormat=function(){var t=readAs(this.arraybuffer,Uint8Array,104),e=(128&t)>>7,n=(64&t)>>6;if(1===e&&1===n)throw Error("Old style compression not supported");this.formatId=63&t,this.isCompressed=1===e||1===n},LASFile.prototype.determineVersion=function(){var t=new Int8Array(this.arraybuffer,24,2);this.version=10*t[0]+t[1],this.versionAsString=t[0]+"."+t[1]},LASFile.prototype.open=function(){return this.loader.open()},LASFile.prototype.getHeader=function(){return this.loader.getHeader()},LASFile.prototype.readData=function(t,e,n){return this.loader.readData(t,e,n)},LASFile.prototype.close=function(){return this.loader.close()};var LASDecoder=function(t,e,n,i,r,o,s,a){this.arrayb=t,this.decoder=pointFormatReaders[e],this.pointsCount=i,this.pointSize=n,this.scale=r,this.offset=o,this.mins=s,this.maxs=a};LASDecoder.prototype.getPoint=function(t){if(0>t||t>=this.pointsCount)throw Error("Point index out of range");return t=new DataView(this.arrayb,t*this.pointSize,this.pointSize),this.decoder(t)},Potree.BinaryLoader=class{constructor(t,e,n){this.version="string"==typeof t?new VersionUtils(t):t,this.boundingBox=e,this.scale=n}load(t){if(!t.loaded){var e=t.getURL();this.version.equalOrHigher("1.4")&&(e+=".bin");var n=this,i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===i.readyState){if(200!==i.status&&0!==i.status||null===i.response)throw Error("Potree: Failed to load file, HTTP status "+i.status);n.parse(t,i.response)}},i.send(null)}}parse(t,e){var n=t.pcoGeometry.pointAttributes,i=e.byteLength/t.pcoGeometry.pointAttributes.byteSize;this.version.upTo("1.5")&&(t.numPoints=i),e={buffer:e,pointAttributes:n,version:this.version.version,min:[t.boundingBox.min.x,t.boundingBox.min.y,t.boundingBox.min.z],offset:[t.pcoGeometry.offset.x,t.pcoGeometry.offset.y,t.pcoGeometry.offset.z],scale:this.scale,spacing:t.spacing,hasChildren:t.hasChildren,name:t.name},Potree.workerPool.runTask(WorkerManager.BINARY_DECODER,function(e){var i,r=e.data,o=r.attributeBuffers,s=new THREE.Box3((new THREE.Vector3).fromArray(r.tightBoundingBox.min),(new THREE.Vector3).fromArray(r.tightBoundingBox.max)),a=new THREE.BufferGeometry;for(i in o){var u=o[i].buffer;parseInt(i)===Potree.PointAttributeNames.POSITION_CARTESIAN?a.addAttribute("position",new THREE.BufferAttribute(new Float32Array(u),3)):parseInt(i)===Potree.PointAttributeNames.COLOR_PACKED?a.addAttribute("color",new THREE.BufferAttribute(new Uint8Array(u),4,!0)):parseInt(i)===Potree.PointAttributeNames.INTENSITY?a.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(u),1)):parseInt(i)===Potree.PointAttributeNames.CLASSIFICATION?a.addAttribute("classification",new THREE.BufferAttribute(new Uint8Array(u),1)):parseInt(i)===Potree.PointAttributeNames.NORMAL_SPHEREMAPPED?a.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(u),3)):parseInt(i)===Potree.PointAttributeNames.NORMAL_OCT16?a.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(u),3)):parseInt(i)===Potree.PointAttributeNames.NORMAL?a.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(u),3)):parseInt(i)===Potree.PointAttributeNames.INDICES?((u=new THREE.BufferAttribute(new Uint8Array(u),4)).normalized=!0,a.addAttribute("indices",u)):parseInt(i)===Potree.PointAttributeNames.SPACING&&(u=new THREE.BufferAttribute(new Float32Array(u),1),a.addAttribute("spacing",u))}s.max.sub(s.min),s.min.set(0,0,0),t.numPoints=e.data.buffer.byteLength/n.byteSize,t.geometry=a,t.mean=new THREE.Vector3(...r.mean),t.tightBoundingBox=s,t.loaded=!0,t.loading=!1,t.estimatedSpacing=r.estimatedSpacing,Potree.numNodesLoading--},e,[e.buffer])}};class GreyhoundUtils{static getQueryParam(t){return t=t.replace(/[[\]]/g,"\\$&"),(t=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(window.location.href))?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null}static createSchema(t){var e=[{name:"X",size:4,type:"signed"},{name:"Y",size:4,type:"signed"},{name:"Z",size:4,type:"signed"}];return t.forEach(function(t){"COLOR_PACKED"===t?(e.push({name:"Red",size:2,type:"unsigned"}),e.push({name:"Green",size:2,type:"unsigned"}),e.push({name:"Blue",size:2,type:"unsigned"})):"INTENSITY"===t?e.push({name:"Intensity",size:2,type:"unsigned"}):"CLASSIFICATION"===t&&e.push({name:"Classification",size:1,type:"unsigned"})}),e}static fetch(t,e){var n=new XMLHttpRequest;n.overrideMimeType("text/plain"),n.open("GET",t,!0),n.onreadystatechange=function(){4===n.readyState&&(200===n.status||0===n.status?e(null,n.responseText):e(n.responseText))},n.send(null)}static fetchBinary(t,e){var n=new XMLHttpRequest;n.overrideMimeType("text/plain"),n.open("GET",t,!0),n.responseType="arraybuffer",n.onreadystatechange=function(){4===n.readyState&&(200===n.status||0===n.status?e(null,n.response):e(n.responseText))},n.send(null)}static pointSizeFrom(t){return t.reduce((t,e)=>t+e.size,0)}static getNormalization(t,e,n){var i=[{name:"X",size:4,type:"floating"},{name:"Y",size:4,type:"floating"},{name:"Z",size:4,type:"floating"},{name:"Red",size:2,type:"unsigned"},{name:"Green",size:2,type:"unsigned"},{name:"Blue",size:2,type:"unsigned"},{name:"Intensity",size:2,type:"unsigned"}];t=t+"read?depth="+e+"&schema="+JSON.stringify(i),GreyhoundUtils.fetchBinary(t,function(t,e){if(t)throw Error(t);t=new DataView(e),e=e.byteLength-4;for(var r=GreyhoundUtils.pointSizeFrom(i),o=!1,s=!1,a=0;a<e&&((255<t.getUint16(a+12,!0)||255<t.getUint16(a+14,!0)||255<t.getUint16(a+16,!0))&&(o=!0),255<t.getUint16(a+18,!0)&&(s=!0),!o||!s);a+=r);n(null,{color:o,intensity:s})})}}Potree.GreyhoundLoader=function(){},Potree.GreyhoundLoader.loadInfoJSON=function(t,e){},Potree.GreyhoundLoader.load=function(t,e){try{var n=t.split("greyhound://")[1];1===n.split("http://").length&&1===n.split("https://").length&&(n="http://"+n),GreyhoundUtils.fetch(n+"info",function(t,i){if(t)throw Error(t);t=JSON.parse(i);var r=new VersionUtils("1.4"),o=t.bounds;i=t.scale||.01,Array.isArray(i)&&(i=Math.min(i[0],i[1],i[2])),GreyhoundUtils.getQueryParam("scale")&&(i=parseFloat(GreyhoundUtils.getQueryParam("scale")));var s=Math.max(8,t.baseDepth),a=["POSITION_CARTESIAN"],u=!1,l=!1,d=!1;t.schema.forEach(function(t){"Intensity"===t.name&&a.push("INTENSITY"),"Classification"===t.name&&a.push("CLASSIFICATION"),"Red"===t.name?u=!0:"Green"===t.name?l=!0:"Blue"===t.name&&(d=!0)}),u&&l&&d&&a.push("COLOR_PACKED");var h=new PointCloudGreyhoundGeometry;h.serverURL=n,h.spacing=(o[3]-o[0])/Math.pow(2,s),h.baseDepth=s,h.hierarchyStepSize=5,h.schema=GreyhoundUtils.createSchema(a),s=GreyhoundUtils.pointSizeFrom(h.schema),h.pointAttributes=new Potree.PointAttributes(a),h.pointAttributes.byteSize=s,s=(o=new THREE.Box3((new THREE.Vector3).fromArray(o,0),(new THREE.Vector3).fromArray(o,3))).min.clone(),o.max.sub(o.min),o.min.set(0,0,0),h.projection=t.srs,h.boundingBox=o,h.boundingSphere=o.getBoundingSphere(new THREE.Sphere),h.scale=i,h.offset=s,h.loader=new Potree.GreyhoundBinaryLoader(r,o,h.scale),r={},(i=new PointCloudGreyhoundGeometryNode("r",h,o,i,s)).level=0,i.hasChildren=!0,i.numPoints=t.numPoints,i.spacing=h.spacing,h.root=i,h.root.load(),r.r=i,h.nodes=r,GreyhoundUtils.getNormalization(n,t.baseDepth,function(t,n){n.color&&(h.normalize.color=!0),n.intensity&&(h.normalize.intensity=!0),e(h)})})}catch(n){console.log("Potree: Loading failed.",t,n),e()}},Potree.GreyhoundLoader.loadPointAttributes=function(t){t=t.pointAttributes;for(var e=new Potree.PointAttributes,n=0;n<t.length;n++)e.add(Potree.PointAttribute[t[n]]);return e},Potree.GreyhoundLoader.createChildAABB=function(t,e){var n=t.min;t=t.max;var i=(new THREE.Vector3).copy(t).sub(n).multiplyScalar(.5),r=new THREE.Vector3(i.x,0,0),o=new THREE.Vector3(0,i.y,0),s=new THREE.Vector3(0,0,i.z),a=n,u=(new THREE.Vector3).add(n).add(i);return 1===e?(n=(new THREE.Vector3).copy(a).add(s),t=(new THREE.Vector3).copy(u).add(s)):3===e?(n=(new THREE.Vector3).copy(a).add(s).add(o),t=(new THREE.Vector3).copy(u).add(s).add(o)):0===e?(n=a,t=u):2===e?(n=(new THREE.Vector3).copy(a).add(o),t=(new THREE.Vector3).copy(u).add(o)):5===e?(n=(new THREE.Vector3).copy(a).add(s).add(r),t=(new THREE.Vector3).copy(u).add(s).add(r)):7===e?(n=(new THREE.Vector3).copy(a).add(i),t=(new THREE.Vector3).copy(u).add(i)):4===e?(n=(new THREE.Vector3).copy(a).add(r),t=(new THREE.Vector3).copy(u).add(r)):6===e&&(n=(new THREE.Vector3).copy(a).add(r).add(o),t=(new THREE.Vector3).copy(u).add(r).add(o)),new THREE.Box3(n,t)},Potree.GreyhoundBinaryLoader=class{constructor(t,e,n){this.version="string"==typeof t?new VersionUtils(t):t,this.boundingBox=e,this.scale=n}load(t){if(!t.loaded){var e=this,n=t.getURL(),i=new XMLHttpRequest;i.overrideMimeType("text/plain"),i.open("GET",n,!0),i.responseType="arraybuffer",i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){4===i.readyState&&(200===i.status||0===i.status?e.parse(t,i.response):console.log("Potree: Failed to load file.",i,n))},i.send(null)}}parse(t,e){var n=new DataView(e,e.byteLength-4,4).getUint32(0,!0),i=t.pcoGeometry.pointAttributes;t.numPoints=n,n=t.boundingBox;var r=t.pcoGeometry.boundingBox.getCenter().sub(t.boundingBox.min);e={buffer:e,pointAttributes:i,version:this.version.version,schema:t.pcoGeometry.schema,min:[n.min.x,n.min.y,n.min.z],max:[n.max.x,n.max.y,n.max.z],offset:r.toArray(),scale:this.scale,normalize:t.pcoGeometry.normalize},Potree.workerPool.runTask(WorkerManager.GREYHOUND,function(e){var n,i=(e=e.data).attributeBuffers,r=new THREE.Box3((new THREE.Vector3).fromArray(e.tightBoundingBox.min),(new THREE.Vector3).fromArray(e.tightBoundingBox.max)),o=new THREE.BufferGeometry;for(n in i){var s=i[n].buffer;parseInt(n)===Potree.PointAttributeNames.POSITION_CARTESIAN?o.addAttribute("position",new THREE.BufferAttribute(new Float32Array(s),3)):parseInt(n)===Potree.PointAttributeNames.COLOR_PACKED?o.addAttribute("color",new THREE.BufferAttribute(new Uint8Array(s),4,!0)):parseInt(n)===Potree.PointAttributeNames.INTENSITY?o.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(s),1)):parseInt(n)===Potree.PointAttributeNames.CLASSIFICATION?o.addAttribute("classification",new THREE.BufferAttribute(new Uint8Array(s),1)):parseInt(n)===Potree.PointAttributeNames.NORMAL_SPHEREMAPPED?o.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(s),3)):parseInt(n)===Potree.PointAttributeNames.NORMAL_OCT16?o.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(s),3)):parseInt(n)===Potree.PointAttributeNames.NORMAL?o.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(s),3)):parseInt(n)===Potree.PointAttributeNames.INDICES?((s=new THREE.BufferAttribute(new Uint8Array(s),4)).normalized=!0,o.addAttribute("indices",s)):parseInt(n)===Potree.PointAttributeNames.SPACING&&(s=new THREE.BufferAttribute(new Float32Array(s),1),o.addAttribute("spacing",s))}r.max.sub(r.min),r.min.set(0,0,0),t.numPoints=e.numPoints,t.geometry=o,t.mean=new THREE.Vector3(...e.mean),t.tightBoundingBox=r,t.loaded=!0,t.loading=!1,Potree.numNodesLoading--},e,[e.buffer])}},Potree.POCLoader=function(){},Potree.POCLoader.load=function(t,e){try{var n=new PointCloudOctreeGeometry;n.url=t;var i=new XMLHttpRequest;i.overrideMimeType("text/plain"),i.open("GET",t,!0),i.onreadystatechange=function(){if(4===i.readyState&&(200===i.status||0===i.status)){var r=JSON.parse(i.responseText),o=new VersionUtils(r.version);0===r.octreeDir.indexOf("http")?n.octreeDir=r.octreeDir:n.octreeDir=t+"/../"+r.octreeDir,n.spacing=r.spacing,n.hierarchyStepSize=r.hierarchyStepSize,n.pointAttributes=r.pointAttributes;var s=new THREE.Vector3(r.boundingBox.lx,r.boundingBox.ly,r.boundingBox.lz),a=new THREE.Vector3(r.boundingBox.ux,r.boundingBox.uy,r.boundingBox.uz),u=new THREE.Box3(s,a);if(a=u.clone(),r.tightBoundingBox&&(a.min.copy(new THREE.Vector3(r.tightBoundingBox.lx,r.tightBoundingBox.ly,r.tightBoundingBox.lz)),a.max.copy(new THREE.Vector3(r.tightBoundingBox.ux,r.tightBoundingBox.uy,r.tightBoundingBox.uz))),s=s.clone(),u.min.sub(s),u.max.sub(s),a.min.sub(s),a.max.sub(s),n.projection=r.projection,n.boundingBox=u,n.tightBoundingBox=a,n.boundingSphere=u.getBoundingSphere(new THREE.Sphere),n.tightBoundingSphere=a.getBoundingSphere(new THREE.Sphere),n.offset=s,"LAS"===r.pointAttributes?n.loader=new Potree.LASLAZLoader(r.version):"LAZ"===r.pointAttributes?n.loader=new Potree.LASLAZLoader(r.version):(n.loader=new Potree.BinaryLoader(r.version,u,r.scale),n.pointAttributes=new Potree.PointAttributes(n.pointAttributes)),s={},(u=new PointCloudOctreeGeometryNode(a="r",n,u)).level=0,u.hasChildren=!0,u.spacing=n.spacing,o.upTo("1.5")?u.numPoints=r.hierarchy[0][1]:u.numPoints=0,n.root=u,n.root.load(),s[a]=u,o.upTo("1.4"))for(o=1;o<r.hierarchy.length;o++){a=r.hierarchy[o][0];var l=r.hierarchy[o][1];u=parseInt(a.charAt(a.length-1));var d=a.substring(0,a.length-1);d=s[d];var h=a.length-1;u=Potree.POCLoader.createChildAABB(d.boundingBox,u),(u=new PointCloudOctreeGeometryNode(a,n,u)).level=h,u.numPoints=l,u.spacing=n.spacing/Math.pow(2,h),d.addChild(u),s[a]=u}n.nodes=s,e(n)}},i.send(null)}catch(n){console.log('loading failed: "'+t+'"'),console.log(n),e()}},Potree.POCLoader.loadPointAttributes=function(t){t=t.pointAttributes;for(var e=new Potree.PointAttributes,n=0;n<t.length;n++)e.add(Potree.PointAttribute[t[n]]);return e},Potree.POCLoader.createChildAABB=function(t,e){var n=t.min.clone();t=t.max.clone();var i=(new THREE.Vector3).subVectors(t,n);return 0<(1&e)?n.z+=i.z/2:t.z-=i.z/2,0<(2&e)?n.y+=i.y/2:t.y-=i.y/2,0<(4&e)?n.x+=i.x/2:t.x-=i.x/2,new THREE.Box3(n,t)},Potree.LASLAZLoader=class{constructor(t){this.version="string"==typeof t?new VersionUtils(t):t}static progressCB(){}load(t){if(!t.loaded){var e=t.pcoGeometry.pointAttributes,n=t.getURL();this.version.equalOrHigher("1.4")&&(n+="."+e.toLowerCase());var i=new XMLHttpRequest;i.open("GET",n,!0),i.responseType="arraybuffer",i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=(()=>{4===i.readyState&&(200===i.status?this.parse(t,i.response):console.log("Potree: Failed to load file! HTTP status: "+i.status+", file: "+n))}),i.send(null)}}parse(t,e){var n=new LASFile(e),i=new Potree.LasLazBatcher(t);n.open().then(t=>(n.isOpen=!0,n)).catch(t=>{console.log("Potree: Failed to open file.")}).then(t=>t.getHeader().then(function(e){return[t,e]})).then(t=>{var e=t[0],n=t[1],r=0,o=n.pointsCount,s=function(){return e.readData(1e6,0,1).then(function(t){return i.push(new LASDecoder(t.buffer,n.pointsFormatId,n.pointsStructSize,t.count,n.scale,n.offset,n.mins,n.maxs)),r+=t.count,Potree.LASLAZLoader.progressCB(r/o),t.hasMoreData?s():(n.totalRead=r,n.versionAsString=e.versionAsString,n.isCompressed=e.isCompressed,[e,n,i])})};return s()}).then(t=>{var e=t[0];return Potree.LASLAZLoader.progressCB(1),e.close().then(function(){return e.isOpen=!1,t.slice(1)}).catch(t=>{if(e.isOpen)return e.close().then(function(){throw e.isOpen=!1,t});throw t})})}handle(t,e){}},Potree.LasLazBatcher=class{constructor(t){this.node=t}push(t){var e=this,n={buffer:t.arrayb,numPoints:t.pointsCount,pointSize:t.pointSize,pointFormatID:2,scale:t.scale,offset:t.offset,mins:t.mins,maxs:t.maxs};Potree.workerPool.runTask(WorkerManager.LAS_DECODER,function(n){var i=new THREE.BufferGeometry,r=t.pointsCount,o=new Float32Array(n.data.position),s=new Uint8Array(n.data.color),a=new Float32Array(n.data.intensity),u=new Uint8Array(n.data.classification),l=new Uint8Array(n.data.returnNumber),d=new Uint8Array(n.data.numberOfReturns),h=new Uint16Array(n.data.pointSourceID),p=new Uint8Array(n.data.indices);i.addAttribute("position",new THREE.BufferAttribute(o,3)),i.addAttribute("color",new THREE.BufferAttribute(s,4,!0)),i.addAttribute("intensity",new THREE.BufferAttribute(a,1)),i.addAttribute("classification",new THREE.BufferAttribute(u,1)),i.addAttribute("returnNumber",new THREE.BufferAttribute(l,1)),i.addAttribute("numberOfReturns",new THREE.BufferAttribute(d,1)),i.addAttribute("pointSourceID",new THREE.BufferAttribute(h,1)),i.addAttribute("indices",new THREE.BufferAttribute(p,4)),i.attributes.indices.normalized=!0,o=new THREE.Box3((new THREE.Vector3).fromArray(n.data.tightBoundingBox.min),(new THREE.Vector3).fromArray(n.data.tightBoundingBox.max)),i.boundingBox=e.node.boundingBox,e.node.tightBoundingBox=o,e.node.geometry=i,e.node.numPoints=r,e.node.loaded=!0,e.node.loading=!1,Potree.numNodesLoading--,e.node.mean=new THREE.Vector3(...n.data.mean)},n,[n.buffer])}},Potree.BasicGroup=class extends THREE.Mesh{constructor(){super(new THREE.Geometry,new THREE.MeshBasicMaterial({opacity:0,wireframe:!1,transparent:!0})),this.rotation.set(-Math.PI/2,0,0),this.frustumCulled=!0,this.pointclouds=[],this.nodeSize=30,this.pointBudget=1e10,this.nodeLoadRate=2}raycast(t,e){}setPointBudget(t){this.pointBudget=t}onBeforeRender(t,e,n,i,r,o){for(e=0;e<this.pointclouds.length;e++)this.pointclouds[e].minimumNodePixelSize=this.nodeSize;Potree.updatePointClouds(this.pointclouds,n,t)}recalculateBoxGeometry(){var t=this.getBoundingBox(),e=t.getSize(new THREE.Vector3),n=t.getCenter(new THREE.Vector3);(t=new THREE.Matrix4).makeTranslation(n.x,-n.z,n.y),(e=new THREE.BoxBufferGeometry(e.x,e.z,e.y)).applyMatrix(t),this.geometry=e}add(t){THREE.Object3D.prototype.add.call(this,t),t instanceof PointCloudTree&&(t.showBoundingBox=!1,t.generateDEM=!1,this.pointclouds.push(t),this.recalculateBoxGeometry())}remove(t){THREE.Object3D.prototype.remove.call(this,t),t instanceof PointCloudTree&&(-1!==(t=this.pointclouds.indexOf(t))&&(this.pointclouds.splice(t,1),this.recalculateBoxGeometry()))}getBoundingBox(){var t=new THREE.Box3;this.updateMatrixWorld(!0);for(var e=0;e<this.pointclouds.length;e++){var n=this.pointclouds[e];n.updateMatrixWorld(!0),n=HelperUtils.computeTransformedBoundingBox(n.pcoGeometry.tightBoundingBox?n.pcoGeometry.tightBoundingBox:n.boundingBox,n.matrixWorld),t.union(n)}return t}estimateHeightAt(t){var e,n=null,i=1/0;for(e of this.pointclouds)if(void 0!==e.root.geometryNode){var r=null,o=1/0,s=t.clone().sub(e.position);s.z=0,s=new THREE.Ray(s,new THREE.Vector3(0,0,1));for(var a=[e.root];0<a.length;){var u=a.pop(),l=u.getBoundingBox();if(s.intersectBox(l))for(var d of(l=u.geometryNode.mean.z+e.position.z+u.geometryNode.boundingBox.min.z,u.geometryNode.spacing<=o&&(r=l,o=u.geometryNode.spacing),Object.keys(u.children)))u.children[d].geometryNode&&a.push(u.children[d])}(null===n||o<i)&&(n=r,i=o)}return n}},Potree.Group=class extends Potree.BasicGroup{constructor(){super(),this.buffers=new Map,this.shaders=new Map,this.textures=new Map,this.types=new Map}getExtensions(t){this.types.set(Float32Array,t.FLOAT),this.types.set(Uint8Array,t.UNSIGNED_BYTE),this.types.set(Uint16Array,t.UNSIGNED_SHORT);var e=t.getExtension("OES_vertex_array_object");t.createVertexArray=e.createVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)}onBeforeRender(t,e,n,i,r,o){for(var s of(super.onBeforeRender(t,e,n,i,r,o),void 0===(e=t.context).bindVertexArray&&this.getExtensions(e),(i=this.fetchOctrees()).octrees))this.renderOctree(t,s,s.visibleNodes,n);e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),t.state.reset()}createBuffer(t,e){var n=new Potree.WebGLBuffer;for(var i in n.vao=t.createVertexArray(),n.numElements=e.attributes.position.count,t.bindVertexArray(n.vao),e.attributes){var r=e.attributes[i],o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,r.array,t.STATIC_DRAW);var s=Potree.attributeLocations[i],a=r.normalized,u=this.types.get(r.array.constructor);void 0!==u&&(t.vertexAttribPointer(s,r.itemSize,u,a,0,0),t.enableVertexAttribArray(s)),n.vbos.set(i,{handle:o,name:i,count:r.count,itemSize:r.itemSize,type:e.attributes.position.array.constructor,version:0})}return t.bindBuffer(t.ARRAY_BUFFER,null),t.bindVertexArray(null),n}updateBuffer(t,e){var n=this.buffers.get(e);for(var i in t.bindVertexArray(n.vao),e.attributes){var r=e.attributes[i],o=Potree.attributeLocations[i],s=r.normalized,a=this.types.get(r.array.constructor);if(n.vbos.has(i)){var u=n.vbos.get(i).handle;n.vbos.get(i).version=r.version}else u=t.createBuffer(),n.vbos.set(i,{handle:u,name:i,count:r.count,itemSize:r.itemSize,type:e.attributes.position.array.constructor,version:r.version});t.bindBuffer(t.ARRAY_BUFFER,u),t.bufferData(t.ARRAY_BUFFER,r.array,t.STATIC_DRAW),t.vertexAttribPointer(o,r.itemSize,a,s,0,0),t.enableVertexAttribArray(o)}t.bindBuffer(t.ARRAY_BUFFER,null),t.bindVertexArray(null)}fetchOctrees(){for(var t=[],e=[this];0<e.length;){var n=e.pop();n instanceof PointCloudTree?t.push(n):(n=n.children.filter(t=>t.visible),e.push(...n))}return{octrees:t}}renderNodes(t,e,n,i,r,o){t=t.context,e=e.material,r=r.matrixWorldInverse;var s,a=new THREE.Matrix4,u=new Float32Array(16);for(s of n)if(void 0===Potree.debug.allowedNodes||Potree.debug.allowedNodes.includes(s.name)){var l=s.sceneNode.matrixWorld;if(a.multiplyMatrices(r,l),i&&(n=i.offsets.get(s),o.setUniform1f("uVNStart",n)),n=s.getLevel(),o.setUniform("uDebug",!0===s.debug),s instanceof PointCloudOctreeNode)var d=0===Object.keys(s.children).length;else s instanceof PointCloudArena4DNode&&(d=s.geometryNode.isLeaf);o.setUniform("uIsLeafNode",d);var h=o.uniformLocations.modelMatrix;if(h&&(u.set(l.elements),t.uniformMatrix4fv(h,!1,u)),h=o.uniformLocations.modelViewMatrix,u.set(a.elements),t.uniformMatrix4fv(h,!1,u),e.clipPolygons&&0<e.clipPolygons.length){h=[];var p=[];for(f of e.clipPolygons){r=f.viewMatrix;var c=f.projMatrix.clone().multiply(r).multiply(l);h.push(f.markers.length),p.push(c)}for(l=[].concat(...p.map(t=>t.elements)),c=Array(24*e.clipPolygons.length),p=0;p<e.clipPolygons.length;p++)for(var f=e.clipPolygons[p],m=0;m<f.markers.length;m++)c[24*p+3*m]=f.markers[m].position.x,c[24*p+(3*m+1)]=f.markers[m].position.y,c[24*p+(3*m+2)]=f.markers[m].position.z;t.uniform1iv(o.uniformLocations["uClipPolygonVCount[0]"],h),t.uniformMatrix4fv(o.uniformLocations["uClipPolygonWVP[0]"],!1,l),t.uniform3fv(o.uniformLocations["uClipPolygonVertices[0]"],c)}if(o.setUniform1f("uLevel",n),o.setUniform1f("uNodeSpacing",s.geometryNode.estimatedSpacing),o.setUniform1f("uPCIndex",p),n=s.geometryNode.geometry,l=null,this.buffers.has(n))for(var g in l=this.buffers.get(n),n.attributes)n.attributes[g].version>l.vbos.get(g).version&&this.updateBuffer(t,n);else l=this.createBuffer(t,n),this.buffers.set(n,l);t.bindVertexArray(l.vao),t.drawArrays(t.POINTS,0,l.numElements)}t.bindVertexArray(null)}renderOctree(t,e,n,i){var r=t.context,o=e.material,s=i.matrixWorldInverse,a=i.matrixWorld,u=i.projectionMatrix,l=(new THREE.Matrix4).getInverse(u);new THREE.Matrix4;var d=null,h=0;if(0<=o.pointSizeType&&(o.pointSizeType===Potree.PointSizeType.ADAPTIVE||o.pointColorType===Potree.PointColorType.LOD)){d=e.computeVisibilityTextureData(n,i);var p=o.visibleNodesTexture;p.image.data.set(d.data),p.needsUpdate=!0}p=null,this.shaders.has(o)?(p=this.shaders.get(o),c=o.vertexShader,f=o.fragmentShader):(p=new Potree.Shader(r,"pointcloud",o.vertexShader,o.fragmentShader),this.shaders.set(o,p));var c=(f=["#define num_shadowmaps0","#define num_snapshots"+(o.snapEnabled?o.numSnapshots:0),"#define num_clipboxes"+(o.clipBoxes&&o.clipBoxes.length?o.clipBoxes.length:0),"#define num_clipspheres0","#define num_clippolygons"+(o.clipPolygons&&o.clipPolygons.length?o.clipPolygons.length:0)].join("\n"))+"\n"+o.vertexShader,f=f+"\n"+o.fragmentShader;for(var m of(p.update(c,f),o.needsUpdate=!1,Object.keys(o.uniforms)))"t"==(c=o.uniforms[m]).type&&(c=c.value)&&(this.textures.has(c)||(f=new Potree.WebGLTexture(r,c),this.textures.set(c,f)),this.textures.get(c).update());if(r.useProgram(p.program),1>o.opacity?(r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE),r.depthMask(!1),r.disable(r.DEPTH_TEST)):(r.disable(r.BLEND),r.depthMask(!0),r.enable(r.DEPTH_TEST)),p.setUniformMatrix4("projectionMatrix",u),p.setUniformMatrix4("viewMatrix",s),p.setUniformMatrix4("uViewInv",a),p.setUniformMatrix4("uProjInv",l),s=o.screenHeight,p.setUniform1f("uScreenWidth",o.screenWidth),p.setUniform1f("uScreenHeight",s),p.setUniform1f("fov",Math.PI*i.fov/180),p.setUniform1f("near",i.near),p.setUniform1f("far",i.far),t.capabilities.logarithmicDepthBuffer&&p.setUniform("logDepthBufFC",2/(Math.log(i.far+1)/Math.LN2)),i instanceof THREE.OrthographicCamera?(p.setUniform("uUseOrthographicCamera",!0),p.setUniform("uOrthoWidth",i.right-i.left),p.setUniform("uOrthoHeight",i.top-i.bottom)):p.setUniform("uUseOrthographicCamera",!1),0===o.clipBoxes.length+o.clipPolygons.length?p.setUniform1i("clipTask",Potree.ClipTask.NONE):p.setUniform1i("clipTask",o.clipTask),p.setUniform1i("clipMethod",o.clipMethod),o.clipBoxes&&0<o.clipBoxes.length&&r.uniformMatrix4fv(p.uniformLocations["clipBoxes[0]"],!1,o.uniforms.clipBoxes.value),p.setUniform1f("size",o.size),p.setUniform1f("maxSize",o.uniforms.maxSize.value),p.setUniform1f("minSize",o.uniforms.minSize.value),p.setUniform1f("uOctreeSpacing",o.spacing),p.setUniform("uOctreeSize",o.uniforms.octreeSize.value),p.setUniform3f("uColor",o.color.toArray()),p.setUniform1f("uOpacity",o.opacity),p.setUniform2f("elevationRange",o.elevationRange),p.setUniform2f("intensityRange",o.intensityRange),p.setUniform1f("intensityGamma",o.intensityGamma),p.setUniform1f("intensityContrast",o.intensityContrast),p.setUniform1f("intensityBrightness",o.intensityBrightness),p.setUniform1f("rgbGamma",o.rgbGamma),p.setUniform1f("rgbContrast",o.rgbContrast),p.setUniform1f("rgbBrightness",o.rgbBrightness),p.setUniform1f("uTransition",o.transition),p.setUniform1f("wRGB",o.weightRGB),p.setUniform1f("wIntensity",o.weightIntensity),p.setUniform1f("wElevation",o.weightElevation),p.setUniform1f("wClassification",o.weightClassification),p.setUniform1f("wReturnNumber",o.weightReturnNumber),p.setUniform1f("wSourceID",o.weightSourceID),s=this.textures.get(o.visibleNodesTexture),p.setUniform1i("visibleNodesTexture",h),r.activeTexture(r.TEXTURE0+h),r.bindTexture(s.target,s.id),h++,s=this.textures.get(o.gradientTexture),p.setUniform1i("gradient",h),r.activeTexture(r.TEXTURE0+h),r.bindTexture(s.target,s.id),h++,s=this.textures.get(o.classificationTexture),p.setUniform1i("classificationLUT",h),r.activeTexture(r.TEXTURE0+h),r.bindTexture(s.target,s.id),h++,!0===o.snapEnabled){for(u=p.uniformLocations["uSnapshot[0]"],l=p.uniformLocations["uSnapshotDepth[0]"],s=Array(5).fill(h).map((t,e)=>t+e),a=Array(5).fill(1+Math.max(...s)).map((t,e)=>t+e),h=1+Math.max(...a),r.uniform1iv(u,s),r.uniform1iv(l,a),h=0;5>h&&(c=o.uniforms.uSnapshot.value[h],l=o.uniforms.uSnapshotDepth.value[h],c);h++)u=t.properties.get(c).__webglTexture,l=t.properties.get(l).__webglTexture,m=a[h],r.activeTexture(r[`TEXTURE${s[h]}`]),r.bindTexture(r.TEXTURE_2D,u),r.activeTexture(r[`TEXTURE${m}`]),r.bindTexture(r.TEXTURE_2D,l);h=[].concat(...o.uniforms.uSnapView.value.map(t=>t.elements)),r.uniformMatrix4fv(p.uniformLocations["uSnapView[0]"],!1,h),h=[].concat(...o.uniforms.uSnapProj.value.map(t=>t.elements)),r.uniformMatrix4fv(p.uniformLocations["uSnapProj[0]"],!1,h),h=[].concat(...o.uniforms.uSnapProjInv.value.map(t=>t.elements)),r.uniformMatrix4fv(p.uniformLocations["uSnapProjInv[0]"],!1,h),h=[].concat(...o.uniforms.uSnapViewInv.value.map(t=>t.elements)),r.uniformMatrix4fv(p.uniformLocations["uSnapViewInv[0]"],!1,h)}this.renderNodes(t,e,n,d,i,p),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE0)}};